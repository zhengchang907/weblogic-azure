{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "3367970600839686909"
    }
  },
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "[deployment().properties.templateLink.uri]"
    },
    "_artifactsLocationSasToken": {
      "type": "secureString",
      "defaultValue": ""
    },
    "aciResourcePermissions": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "true to use resource or workspace permissions. false to require workspace permissions."
      }
    },
    "aciRetentionInDays": {
      "type": "int",
      "defaultValue": 120,
      "metadata": {
        "description": "Number of days to retain data in Azure Monitor workspace."
      }
    },
    "aciWorkspaceSku": {
      "type": "string",
      "defaultValue": "pergb2018",
      "metadata": {
        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
      }
    },
    "acrName": {
      "type": "string",
      "defaultValue": "acr-contoso"
    },
    "aksAgentPoolName": {
      "type": "string",
      "defaultValue": "agentpool",
      "metadata": {
        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
      },
      "minLength": 1,
      "maxLength": 12
    },
    "aksAgentPoolNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
      },
      "minValue": 1,
      "maxValue": 10000
    },
    "aksAgentPoolVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "metadata": {
        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
      }
    },
    "aksClusterNamePrefix": {
      "type": "string",
      "defaultValue": "wlsonaks",
      "metadata": {
        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
      }
    },
    "aksClusterRGName": {
      "type": "string",
      "defaultValue": "aks-contoso-rg",
      "metadata": {
        "description": "Resource group name of an existing AKS cluster."
      }
    },
    "aksClusterName": {
      "type": "string",
      "defaultValue": "aks-contoso",
      "metadata": {
        "description": "Name of an existing AKS cluster."
      }
    },
    "aksVersion": {
      "type": "string",
      "defaultValue": "default",
      "metadata": {
        "description": "The AKS version."
      }
    },
    "appGatewayCertificateOption": {
      "type": "string",
      "defaultValue": "haveCert",
      "metadata": {
        "description": "Three scenarios we support for deploying app gateway"
      },
      "allowedValues": [
        "haveCert",
        "haveKeyVault",
        "generateCert"
      ]
    },
    "appGatewayPublicIPAddressName": {
      "type": "string",
      "defaultValue": "gwip",
      "metadata": {
        "description": "Public IP Name for the Application Gateway"
      }
    },
    "appGatewaySSLBackendRootCertData": {
      "type": "string",
      "defaultValue": "appgw-ssl-backend-data",
      "metadata": {
        "description": "The one-line, base64 string of the backend SSL root certificate data."
      }
    },
    "appGatewaySSLCertData": {
      "type": "string",
      "defaultValue": "appgw-ssl-data",
      "metadata": {
        "description": "The one-line, base64 string of the SSL certificate data."
      }
    },
    "appGatewaySSLCertPassword": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The value of the password for the SSL Certificate"
      }
    },
    "appgwForAdminServer": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Create Application Gateway ingress for admin console."
      }
    },
    "appgwForRemoteConsole": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Create Application Gateway ingress for remote console."
      }
    },
    "appgwUsePrivateIP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, configure Azure Application Gateway frontend IP with private IP."
      }
    },
    "appPackageUrls": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Urls of Java EE application packages."
      }
    },
    "appReplicas": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The number of managed server to start."
      }
    },
    "createACR": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to create a new Azure Container Registry."
      }
    },
    "createAKSCluster": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "true to create a new AKS cluster."
      }
    },
    "createDNSZone": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, the template will update records to the existing DNS Zone. If false, the template will create a new DNS Zone."
      }
    },
    "databaseType": {
      "type": "string",
      "defaultValue": "oracle",
      "metadata": {
        "description": "One of the supported database types"
      },
      "allowedValues": [
        "oracle",
        "postgresql",
        "sqlserver",
        "otherdb"
      ]
    },
    "dbConfigurationType": {
      "type": "string",
      "defaultValue": "createOrUpdate",
      "metadata": {
        "description": "createOrUpdate: create a new data source connection, or update an existing data source connection. delete: delete an existing data source connection"
      },
      "allowedValues": [
        "createOrUpdate",
        "delete"
      ]
    },
    "dbDriverLibrariesUrls": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Urls of datasource drivers, must be specified if database type is otherdb"
      }
    },
    "dbDriverName": {
      "type": "string",
      "defaultValue": "org.contoso.Driver",
      "metadata": {
        "description": "Datasource driver name, must be specified if database type is otherdb"
      }
    },
    "dbGlobalTranPro": {
      "type": "string",
      "defaultValue": "EmulateTwoPhaseCommit",
      "metadata": {
        "description": "Determines the transaction protocol (global transaction processing behavior) for the data source."
      }
    },
    "dbPassword": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password for Database"
      }
    },
    "dbTestTableName": {
      "type": "string",
      "defaultValue": "Null",
      "metadata": {
        "description": "The name of the database table to use when testing physical database connections. This name is required when you specify a Test Frequency and enable Test Reserved Connections."
      }
    },
    "dbUser": {
      "type": "string",
      "defaultValue": "contosoDbUser",
      "metadata": {
        "description": "User id of Database"
      }
    },
    "dnsNameforApplicationGateway": {
      "type": "string",
      "defaultValue": "wlsgw",
      "metadata": {
        "description": "DNS prefix for ApplicationGateway"
      }
    },
    "dnszoneAdminConsoleLabel": {
      "type": "string",
      "defaultValue": "admin",
      "metadata": {
        "description": "Specify a label used to generate subdomain of Admin server. The final subdomain name will be label.dnszoneName, e.g. admin.contoso.xyz"
      }
    },
    "dnszoneAdminT3ChannelLabel": {
      "type": "string",
      "defaultValue": "admin-t3",
      "metadata": {
        "description": "Specify a label used to generate subdomain of Admin server T3 channel. The final subdomain name will be label.dnszoneName, e.g. admin-t3.contoso.xyz"
      }
    },
    "dnszoneClusterLabel": {
      "type": "string",
      "defaultValue": "www",
      "metadata": {
        "description": "Specify a label used to generate subdomain of WebLogic cluster. The final subdomain name will be label.dnszoneName, e.g. applications.contoso.xyz"
      }
    },
    "dnszoneClusterT3ChannelLabel": {
      "type": "string",
      "defaultValue": "cluster-t3"
    },
    "dnszoneName": {
      "type": "string",
      "defaultValue": "contoso.xyz",
      "metadata": {
        "description": "Azure DNS Zone name."
      }
    },
    "dnszoneRGName": {
      "type": "string",
      "defaultValue": "dns-contoso-rg"
    },
    "dsConnectionURL": {
      "type": "string",
      "defaultValue": "jdbc:postgresql://contoso.postgres.database.azure.com:5432/postgres",
      "metadata": {
        "description": "JDBC Connection String"
      }
    },
    "enableAppGWIngress": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to set up Application Gateway ingress."
      }
    },
    "enableAzureMonitoring": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
      }
    },
    "enableAzureFileShare": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to create persistent volume using file share."
      }
    },
    "enableCookieBasedAffinity": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "true to enable cookie based affinity."
      }
    },
    "enableCustomSSL": {
      "type": "bool",
      "defaultValue": false
    },
    "enableDB": {
      "type": "bool",
      "defaultValue": false
    },
    "enableDNSConfiguration": {
      "type": "bool",
      "defaultValue": false
    },
    "enableAdminT3Tunneling": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Configure a custom channel in Admin Server for the T3 protocol that enables HTTP tunneling"
      }
    },
    "enableClusterT3Tunneling": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Configure a custom channel in WebLogic cluster for the T3 protocol that enables HTTP tunneling"
      }
    },
    "identity": {
      "type": "object",
      "metadata": {
        "description": "An user assigned managed identity. Make sure the identity has permission to create/update/delete/list Azure resources."
      }
    },
    "isSSOSupportEntitled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Is the specified SSO account associated with an active Oracle support contract?"
      }
    },
    "jdbcDataSourceName": {
      "type": "string",
      "defaultValue": "jdbc/contoso",
      "metadata": {
        "description": "JNDI Name for JDBC Datasource"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "kv-contoso",
      "metadata": {
        "description": "Existing Key Vault Name"
      }
    },
    "keyVaultResourceGroup": {
      "type": "string",
      "defaultValue": "kv-contoso-rg",
      "metadata": {
        "description": "Resource group name in current subscription containing the KeyVault"
      }
    },
    "keyVaultSku": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "Price tier for Key Vault."
      }
    },
    "keyVaultSSLBackendRootCertDataSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-backend-data",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the SSL Root Certificate Data for Appliation Gateway backend TLS/SSL."
      }
    },
    "keyVaultSSLCertDataSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-data",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the SSL Certificate Data for Appliation Gateway frontend TLS/SSL."
      }
    },
    "keyVaultSSLCertPasswordSecretName": {
      "type": "string",
      "defaultValue": "kv-ssl-psw",
      "metadata": {
        "description": "The name of the secret in the specified KeyVault whose value is the password for the SSL Certificate of Appliation Gateway frontend TLS/SSL"
      }
    },
    "location": {
      "type": "string"
    },
    "lbSvcValues": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Object array to define Load Balancer service, each object must include service name, service target[admin-server or cluster-1], port."
      }
    },
    "managedServerPrefix": {
      "type": "string",
      "defaultValue": "managed-server",
      "metadata": {
        "description": "Name prefix of managed server."
      }
    },
    "newOrExistingVnetForApplicationGateway": {
      "type": "string",
      "defaultValue": "new",
      "metadata": {
        "description": "To mitigate ARM-TTK error: Control Named vnetForApplicationGateway must output the newOrExisting property when hideExisting is false"
      }
    },
    "ocrSSOPSW": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password of Oracle SSO account."
      }
    },
    "ocrSSOUser": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User name of Oracle SSO account."
      }
    },
    "servicePrincipal": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Base64 string of service principal. use the command to generate a testing string: az ad sp create-for-rbac --sdk-auth --role Contributor --scopes /subscriptions/<AZURE_SUBSCRIPTION_ID> | base64 -w0"
      }
    },
    "sslConfigurationAccessOption": {
      "type": "string",
      "defaultValue": "uploadConfig",
      "metadata": {
        "description": "Two scenarios to refer to WebLogic Server TLS/SSL certificates."
      },
      "allowedValues": [
        "uploadConfig",
        "keyVaultStoredConfig"
      ]
    },
    "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-identity-data",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Identity Keystore Data"
      }
    },
    "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-identity-psw",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Identity Keystore Passphrase"
      }
    },
    "sslKeyVaultCustomIdentityKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Identity Keystore type"
      }
    },
    "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-trust-data",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Trust Store Data"
      }
    },
    "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-trust-psw",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Custom Trust Store Passphrase"
      }
    },
    "sslKeyVaultCustomTrustKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "WWeblogic Custom Trust Store type"
      }
    },
    "sslKeyVaultName": {
      "type": "string",
      "defaultValue": "kv-wls-ssl-name",
      "metadata": {
        "description": "Resource group containing Weblogic SSL certificates"
      }
    },
    "sslKeyVaultPrivateKeyAliasSecretName": {
      "type": "string",
      "defaultValue": "contoso",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Server private key alias"
      }
    },
    "sslKeyVaultPrivateKeyPassPhraseSecretName": {
      "type": "string",
      "defaultValue": "kv-wls-ssl-alias",
      "metadata": {
        "description": "Secret name in KeyVault containing Weblogic Server private key passphrase"
      }
    },
    "sslKeyVaultResourceGroup": {
      "type": "string",
      "defaultValue": "rg-kv-wls-ssl-name",
      "metadata": {
        "description": "Keyvault name containing Weblogic SSL certificates"
      }
    },
    "sslUploadedCustomIdentityKeyStoreData": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Identity Store Data"
      }
    },
    "sslUploadedCustomIdentityKeyStorePassphrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Identity Store passphrase"
      }
    },
    "sslUploadedCustomIdentityKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Identity Store Type"
      }
    },
    "sslUploadedCustomTrustKeyStoreData": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Trust Store data"
      }
    },
    "sslUploadedCustomTrustKeyStorePassPhrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Custom Trust Store passphrase"
      }
    },
    "sslUploadedCustomTrustKeyStoreType": {
      "type": "string",
      "defaultValue": "PKCS12",
      "allowedValues": [
        "JKS",
        "PKCS12"
      ],
      "metadata": {
        "description": "Weblogic Custom Trust Store Type"
      }
    },
    "sslUploadedPrivateKeyAlias": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Alias of the private key"
      }
    },
    "sslUploadedPrivateKeyPassPhrase": {
      "type": "secureString",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Password of the private key"
      }
    },
    "t3ChannelAdminPort": {
      "type": "int",
      "defaultValue": 7005,
      "metadata": {
        "description": "Public port of the custom T3 channel in admin server"
      }
    },
    "t3ChannelClusterPort": {
      "type": "int",
      "defaultValue": 8011,
      "metadata": {
        "description": "Public port of the custom T3 channel in WebLoigc cluster"
      }
    },
    "useLatestSupportedAksVersion": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "True to use latest supported Kubernetes version."
      }
    },
    "useInternalLB": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "True to set up internal load balancer service."
      }
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "ture to upload Java EE applications and deploy the applications to WebLogic domain."
      }
    },
    "userProvidedAcr": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User provided ACR for base image"
      }
    },
    "userProvidedImagePath": {
      "type": "string",
      "defaultValue": "null",
      "metadata": {
        "description": "User provided base image path"
      }
    },
    "useOracleImage": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Use Oracle images or user provided patched images"
      }
    },
    "validateApplications": {
      "type": "bool",
      "defaultValue": false
    },
    "vnetForApplicationGateway": {
      "type": "object",
      "defaultValue": {
        "name": "wlsaks-app-gateway-vnet",
        "resourceGroup": "[resourceGroup().name]",
        "addressPrefixes": [
          "172.16.0.0/24"
        ],
        "addressPrefix": "172.16.0.0/24",
        "newOrExisting": "new",
        "subnets": {
          "gatewaySubnet": {
            "name": "wlsaks-gateway-subnet",
            "addressPrefix": "172.16.0.0/24",
            "startAddress": "172.16.0.4"
          }
        }
      },
      "metadata": {
        "description": "VNET for Application Gateway."
      }
    },
    "vnetRGNameForApplicationGateway": {
      "type": "string",
      "defaultValue": "vnet-contoso-rg-name",
      "metadata": {
        "description": "To mitigate ARM-TTK error: Control Named vnetForApplicationGateway must output the resourceGroup property when hideExisting is false"
      }
    },
    "wdtRuntimePassword": {
      "type": "secureString",
      "metadata": {
        "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
      }
    },
    "wlsClusterSize": {
      "type": "int",
      "defaultValue": 5,
      "metadata": {
        "description": "Maximum cluster size."
      }
    },
    "wlsCPU": {
      "type": "string",
      "defaultValue": "200m",
      "metadata": {
        "description": "Requests for CPU resources for admin server and managed server."
      }
    },
    "wlsDomainName": {
      "type": "string",
      "defaultValue": "domain1",
      "metadata": {
        "description": "Name of WebLogic domain to create."
      }
    },
    "wlsDomainUID": {
      "type": "string",
      "defaultValue": "sample-domain1",
      "metadata": {
        "description": "UID of WebLogic domain, used in WebLogic Operator."
      }
    },
    "wlsImageTag": {
      "type": "string",
      "defaultValue": "12.2.1.4",
      "metadata": {
        "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
      }
    },
    "wlsJavaOption": {
      "type": "string",
      "defaultValue": "null"
    },
    "wlsMemory": {
      "type": "string",
      "defaultValue": "1.5Gi",
      "metadata": {
        "description": "Memory requests for admin server and managed server."
      }
    },
    "wlsPassword": {
      "type": "secureString"
    },
    "wlsUserName": {
      "type": "string",
      "defaultValue": "weblogic",
      "metadata": {
        "description": "User name for WebLogic Administrator."
      }
    }
  },
  "functions": [],
  "variables": {
    "_enableCustomSSL": "[parameters('enableCustomSSL')]",
    "_enableAppGWIngress": "[parameters('enableAppGWIngress')]",
    "_appGatewaySubnetStartAddress": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.startAddress]",
    "_useExistingAppGatewaySSLCertificate": "[if(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveCert')), true(), false())]",
    "const_appGatewaySSLCertOptionHaveCert": "haveCert",
    "const_appGatewaySSLCertOptionHaveKeyVault": "haveKeyVault",
    "const_azureSubjectName": "[format('{0}.{1}.{2}', variables('name_domainLabelforApplicationGateway'), parameters('location'), 'cloudapp.azure.com')]",
    "const_hasTags": "[contains(resourceGroup(), 'tags')]",
    "const_bCreateNewKeyVault": "[and(or(or(not(variables('const_hasTags')), not(contains(resourceGroup().tags, variables('name_tagNameForKeyVault')))), empty(resourceGroup().tags.wlsKeyVault)), or(and(parameters('enableCustomSSL'), not(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')))), and(parameters('enableAppGWIngress'), not(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))))))]",
    "const_createNewAcr": "[and(parameters('useOracleImage'), parameters('createACR'))]",
    "const_defaultKeystoreType": "PKCS12",
    "const_enableNetworking": "[or(greater(length(parameters('lbSvcValues')), 0), parameters('enableAppGWIngress'))]",
    "const_enablePV": "[or(parameters('enableCustomSSL'), parameters('enableAzureFileShare'))]",
    "const_identityKeyStoreType": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStoreType'), parameters('sslUploadedCustomIdentityKeyStoreType'))]",
    "const_keyvaultNameFromTag": "[if(and(variables('const_hasTags'), contains(resourceGroup().tags, variables('name_tagNameForKeyVault'))), resourceGroup().tags.wlsKeyVault, '')]",
    "const_showAdminConsoleExUrl": "[or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForAdminServer')))]",
    "const_showRemoteAdminConsoleExUrl": "[and(or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForRemoteConsole'))), not(parameters('enableCustomSSL')))]",
    "const_showRemoteAdminConsoleSecuredExUrl": "[and(or(greater(length(parameters('lbSvcValues')), 0), and(parameters('enableAppGWIngress'), parameters('appgwForRemoteConsole'))), parameters('enableCustomSSL'))]",
    "const_trustKeyStoreType": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStoreType'), parameters('sslUploadedCustomTrustKeyStoreType'))]",
    "const_wlsClusterName": "cluster-1",
    "const_wlsJavaOptions": "[if(equals(parameters('wlsJavaOption'), ''), 'null', parameters('wlsJavaOption'))]",
    "const_wlsSSLCertOptionKeyVault": "keyVaultStoredConfig",
    "name_defaultPidDeployment": "pid",
    "name_dnsNameforApplicationGateway": "[concat(parameters('dnsNameforApplicationGateway'), take(parameters('utcValue'), 6))]",
    "name_domainLabelforApplicationGateway": "[take(concat(variables('name_dnsNameforApplicationGateway'), '-', toLower(variables('name_rgNameWithoutSpecialCharacter')), '-', toLower(parameters('wlsDomainName'))), 63)]",
    "name_identityKeyStoreDataSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName'), 'myIdentityKeyStoreData')]",
    "name_identityKeyStorePswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName'), 'myIdentityKeyStorePsw')]",
    "name_keyVaultName": "[if(empty(variables('const_keyvaultNameFromTag')), take(concat('wls-kv', uniqueString(parameters('utcValue'))), 24), resourceGroup().tags.wlsKeyVault)]",
    "name_privateKeyAliasSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultPrivateKeyAliasSecretName'), 'privateKeyAlias')]",
    "name_privateKeyPswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultPrivateKeyPassPhraseSecretName'), 'privateKeyPsw')]",
    "name_rgNameWithoutSpecialCharacter": "[replace(replace(replace(replace(resourceGroup().name, '.', ''), '(', ''), ')', ''), '_', '')]",
    "name_rgKeyvaultForWLSSSL": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultResourceGroup'), resourceGroup().name)]",
    "name_tagNameForKeyVault": "wlsKeyVault",
    "name_tagNameForStorageAccount": "wlsStorageAccount",
    "name_trustKeyStoreDataSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName'), 'myTrustKeyStoreData')]",
    "name_trustKeyStorePswSecret": "[if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName'), 'myTrustKeyStorePsw')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/tags",
      "apiVersion": "2021-04-01",
      "name": "default",
      "properties": {
        "tags": {
          "[variables('name_tagNameForKeyVault')]": "[if(variables('const_bCreateNewKeyVault'), variables('name_keyVaultName'), variables('const_keyvaultNameFromTag'))]",
          "[variables('name_tagNameForStorageAccount')]": "[if(or(and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))))), variables('const_enablePV')), and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null')))), if(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))), reference('query-existing-storage-account').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue')))), '')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "initialization",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "3360241215376299589"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": "pid"
            }
          },
          "functions": [],
          "resources": [
            {
              "condition": "[not(equals(parameters('name'), 'pid'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[parameters('name')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6023100456016179368"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "This is an empty deployment"
                    }
                  },
                  "functions": [],
                  "resources": [],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "appgwEnd": {
              "type": "string",
              "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
            },
            "appgwStart": {
              "type": "string",
              "value": "01288010-2672-5831-a66b-7b8b45cace1b"
            },
            "dbEnd": {
              "type": "string",
              "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
            },
            "dbStart": {
              "type": "string",
              "value": "0cc86800-37f4-5191-9368-2953394309ec"
            },
            "dnsEnd": {
              "type": "string",
              "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
            },
            "dnsStart": {
              "type": "string",
              "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
            },
            "lbEnd": {
              "type": "string",
              "value": "ce664543-77bd-515a-832e-107e32f99da9"
            },
            "lbStart": {
              "type": "string",
              "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
            },
            "networkingEnd": {
              "type": "string",
              "value": "2798165c-49fa-5701-b608-b80ed3986176"
            },
            "networkingStart": {
              "type": "string",
              "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
            },
            "wlsAKSEnd": {
              "type": "string",
              "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
            },
            "wlsAKSStart": {
              "type": "string",
              "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
            },
            "wlsClusterAppEnd": {
              "type": "string",
              "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
            },
            "wlsClusterAppStart": {
              "type": "string",
              "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "pid-a1775ed4-512c-4cfa-9e68-f0b09b36de90-partnercenter",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "6023100456016179368"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": "This is an empty deployment"
            }
          },
          "functions": [],
          "resources": [],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "pre-azure-resources-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrName": {
            "value": "[parameters('acrName')]"
          },
          "createNewAcr": {
            "value": "[variables('const_createNewAcr')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "16379657565991259128"
            }
          },
          "parameters": {
            "acrName": {
              "type": "string",
              "defaultValue": "acr-contoso"
            },
            "createNewAcr": {
              "type": "bool",
              "defaultValue": false
            },
            "location": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "condition": "[parameters('createNewAcr')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "acr-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "12077006738513481980"
                    }
                  },
                  "parameters": {
                    "acrNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsaksacr"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "name_acr": "[format('{0}{1}', parameters('acrNamePrefix'), uniqueString(parameters('utcValue')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ContainerRegistry/registries",
                      "apiVersion": "2021-09-01",
                      "name": "[variables('name_acr')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Standard"
                      },
                      "properties": {
                        "adminUserEnabled": true,
                        "policies": {
                          "quarantinePolicy": {
                            "status": "disabled"
                          },
                          "trustPolicy": {
                            "type": "Notary",
                            "status": "disabled"
                          },
                          "retentionPolicy": {
                            "days": 7,
                            "status": "disabled"
                          }
                        },
                        "encryption": {
                          "status": "disabled"
                        },
                        "dataEndpointEnabled": false,
                        "publicNetworkAccess": "Enabled",
                        "networkRuleBypassOptions": "AzureServices",
                        "zoneRedundancy": "Disabled",
                        "anonymousPullEnabled": false
                      }
                    }
                  ],
                  "outputs": {
                    "acrName": {
                      "type": "string",
                      "value": "[variables('name_acr')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "acrName": {
              "type": "string",
              "value": "[if(parameters('createNewAcr'), reference(resourceId('Microsoft.Resources/deployments', 'acr-deployment'), '2019-10-01').outputs.acrName.value, parameters('acrName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'pid-a1775ed4-512c-4cfa-9e68-f0b09b36de90-partnercenter')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "validate-parameters-and-fail-fast",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment'), '2019-10-01').outputs.acrName.value]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "aksAgentPoolVMSize": {
            "value": "[parameters('aksAgentPoolVMSize')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[parameters('aksVersion')]"
          },
          "appGatewayCertificateOption": {
            "value": "[parameters('appGatewayCertificateOption')]"
          },
          "appGatewaySSLCertData": {
            "value": "[parameters('appGatewaySSLCertData')]"
          },
          "appGatewaySSLCertPassword": {
            "value": "[parameters('appGatewaySSLCertPassword')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createDNSZone": {
            "value": "[parameters('createDNSZone')]"
          },
          "dnszoneName": {
            "value": "[parameters('dnszoneName')]"
          },
          "dnszoneRGName": {
            "value": "[parameters('dnszoneRGName')]"
          },
          "enableAppGWIngress": {
            "value": "[parameters('enableAppGWIngress')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableDNSConfiguration": {
            "value": "[parameters('enableDNSConfiguration')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('keyVaultResourceGroup')]"
          },
          "keyVaultSSLCertDataSecretName": {
            "value": "[parameters('keyVaultSSLCertDataSecretName')]"
          },
          "keyVaultSSLCertPasswordSecretName": {
            "value": "[parameters('keyVaultSSLCertPasswordSecretName')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "servicePrincipal": {
            "value": "[parameters('servicePrincipal')]"
          },
          "sslConfigurationAccessOption": {
            "value": "[parameters('sslConfigurationAccessOption')]"
          },
          "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName')]"
          },
          "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName')]"
          },
          "sslKeyVaultCustomIdentityKeyStoreType": {
            "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreType')]"
          },
          "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName')]"
          },
          "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName')]"
          },
          "sslKeyVaultCustomTrustKeyStoreType": {
            "value": "[parameters('sslKeyVaultCustomTrustKeyStoreType')]"
          },
          "sslKeyVaultName": {
            "value": "[parameters('sslKeyVaultName')]"
          },
          "sslKeyVaultPrivateKeyAliasSecretName": {
            "value": "[parameters('sslKeyVaultPrivateKeyAliasSecretName')]"
          },
          "sslKeyVaultPrivateKeyPassPhraseSecretName": {
            "value": "[parameters('sslKeyVaultPrivateKeyPassPhraseSecretName')]"
          },
          "sslKeyVaultResourceGroup": {
            "value": "[parameters('sslKeyVaultResourceGroup')]"
          },
          "sslUploadedCustomIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "sslUploadedCustomIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "sslUploadedCustomIdentityKeyStoreType": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreType')]"
          },
          "sslUploadedCustomTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "sslUploadedCustomTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "sslUploadedCustomTrustKeyStoreType": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreType')]"
          },
          "sslUploadedPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "sslUploadedPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "useAksWellTestedVersion": {
            "value": "[parameters('useLatestSupportedAksVersion')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "vnetForApplicationGateway": {
            "value": "[parameters('vnetForApplicationGateway')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "11360536549268475826"
            }
          },
          "parameters": {
            "acrName": {
              "type": "string"
            },
            "aksAgentPoolNodeCount": {
              "type": "int"
            },
            "aksAgentPoolVMSize": {
              "type": "string"
            },
            "aksClusterRGName": {
              "type": "string"
            },
            "aksClusterName": {
              "type": "string"
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default"
            },
            "appGatewayCertificateOption": {
              "type": "string"
            },
            "appGatewaySSLCertData": {
              "type": "string"
            },
            "appGatewaySSLCertPassword": {
              "type": "secureString"
            },
            "createAKSCluster": {
              "type": "bool"
            },
            "createDNSZone": {
              "type": "bool"
            },
            "dnszoneName": {
              "type": "string"
            },
            "dnszoneRGName": {
              "type": "string"
            },
            "enableAppGWIngress": {
              "type": "bool"
            },
            "enableCustomSSL": {
              "type": "bool"
            },
            "enableDNSConfiguration": {
              "type": "bool"
            },
            "keyVaultName": {
              "type": "string"
            },
            "keyVaultResourceGroup": {
              "type": "string"
            },
            "keyVaultSSLCertDataSecretName": {
              "type": "string"
            },
            "keyVaultSSLCertPasswordSecretName": {
              "type": "string"
            },
            "identity": {
              "type": "object"
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "ocrSSOPSW": {
              "type": "secureString"
            },
            "ocrSSOUser": {
              "type": "string"
            },
            "servicePrincipal": {
              "type": "secureString"
            },
            "sslConfigurationAccessOption": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStoreDataSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomIdentityKeyStoreType": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStoreDataSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStorePassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultCustomTrustKeyStoreType": {
              "type": "string"
            },
            "sslKeyVaultName": {
              "type": "string"
            },
            "sslKeyVaultPrivateKeyAliasSecretName": {
              "type": "string"
            },
            "sslKeyVaultPrivateKeyPassPhraseSecretName": {
              "type": "string"
            },
            "sslKeyVaultResourceGroup": {
              "type": "string"
            },
            "sslUploadedCustomIdentityKeyStoreData": {
              "type": "secureString"
            },
            "sslUploadedCustomIdentityKeyStorePassphrase": {
              "type": "secureString"
            },
            "sslUploadedCustomIdentityKeyStoreType": {
              "type": "string"
            },
            "sslUploadedCustomTrustKeyStoreData": {
              "type": "secureString"
            },
            "sslUploadedCustomTrustKeyStorePassPhrase": {
              "type": "secureString"
            },
            "sslUploadedCustomTrustKeyStoreType": {
              "type": "string"
            },
            "sslUploadedPrivateKeyAlias": {
              "type": "secureString"
            },
            "sslUploadedPrivateKeyPassPhrase": {
              "type": "secureString"
            },
            "useAksWellTestedVersion": {
              "type": "bool",
              "defaultValue": true
            },
            "userProvidedAcr": {
              "type": "string"
            },
            "userProvidedImagePath": {
              "type": "string"
            },
            "useOracleImage": {
              "type": "bool"
            },
            "vnetForApplicationGateway": {
              "type": "object"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsImageTag": {
              "type": "string"
            }
          },
          "functions": [],
          "variables": {
            "const_arguments": "[format('{0} {1} {2} {3} {4} {5} {6} {7} {8} {9} {10} {11}', parameters('location'), parameters('createAKSCluster'), parameters('aksAgentPoolVMSize'), parameters('aksAgentPoolNodeCount'), parameters('useOracleImage'), parameters('wlsImageTag'), parameters('userProvidedImagePath'), parameters('enableCustomSSL'), parameters('sslConfigurationAccessOption'), parameters('appGatewayCertificateOption'), parameters('enableAppGWIngress'), variables('const_checkDNSZone'))]",
            "const_azcliVersion": "2.15.0",
            "const_checkDNSZone": "[and(parameters('enableDNSConfiguration'), not(parameters('createDNSZone')))]",
            "const_deploymentName": "ds-validate-parameters-and-fail-fast"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[variables('const_deploymentName')]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[variables('const_azcliVersion')]",
                "arguments": "[variables('const_arguments')]",
                "environmentVariables": [
                  {
                    "name": "ORACLE_ACCOUNT_NAME",
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  {
                    "name": "ORACLE_ACCOUNT_PASSWORD",
                    "secureValue": "[parameters('ocrSSOPSW')]"
                  },
                  {
                    "name": "ORACLE_ACCOUNT_ENTITLED",
                    "value": "[string(parameters('isSSOSupportEntitled'))]"
                  },
                  {
                    "name": "ACR_NAME",
                    "value": "[parameters('acrName')]"
                  },
                  {
                    "name": "ACR_NAME_FOR_USER_PROVIDED_IMAGE",
                    "value": "[parameters('userProvidedAcr')]"
                  },
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_VERSION",
                    "value": "[parameters('aksVersion')]"
                  },
                  {
                    "name": "BASE64_FOR_SERVICE_PRINCIPAL",
                    "secureValue": "[parameters('servicePrincipal')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_NAME",
                    "value": "[parameters('sslKeyVaultName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_RESOURCEGROUP_NAME",
                    "value": "[parameters('sslKeyVaultResourceGroup')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_DATA_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreDataSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_PASSWORD_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStorePassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_IDENTITY_TYPE",
                    "value": "[parameters('sslKeyVaultCustomIdentityKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_DATA_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStoreDataSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_PASSWORD_SECRET_NAME",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStorePassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_TRUST_TYPE",
                    "value": "[parameters('sslKeyVaultCustomTrustKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_PRIVATE_KEY_ALIAS",
                    "value": "[parameters('sslKeyVaultPrivateKeyAliasSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_KEYVAULT_PRIVATE_KEY_PASSWORD",
                    "value": "[parameters('sslKeyVaultPrivateKeyPassPhraseSecretName')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_DATA",
                    "secureValue": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_PASSWORD",
                    "secureValue": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
                  },
                  {
                    "name": "WLS_SSL_IDENTITY_TYPE",
                    "value": "[parameters('sslUploadedCustomIdentityKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_DATA",
                    "secureValue": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_PASSWORD",
                    "secureValue": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
                  },
                  {
                    "name": "WLS_SSL_TRUST_TYPE",
                    "value": "[parameters('sslUploadedCustomTrustKeyStoreType')]"
                  },
                  {
                    "name": "WLS_SSL_PRIVATE_KEY_ALIAS",
                    "secureValue": "[parameters('sslUploadedPrivateKeyAlias')]"
                  },
                  {
                    "name": "WLS_SSL_PRIVATE_KEY_PASSWORD",
                    "secureValue": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_NAME",
                    "value": "[parameters('keyVaultName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_RESOURCEGROUP",
                    "value": "[parameters('keyVaultResourceGroup')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_DATA_SECRET_NAME",
                    "value": "[parameters('keyVaultSSLCertDataSecretName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_PASSWORD_SECRET_NAME",
                    "value": "[parameters('keyVaultSSLCertPasswordSecretName')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_FRONTEND_CERT_DATA",
                    "value": "[parameters('appGatewaySSLCertData')]"
                  },
                  {
                    "name": "APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD",
                    "value": "[parameters('appGatewaySSLCertPassword')]"
                  },
                  {
                    "name": "DNS_ZONE_NAME",
                    "value": "[parameters('dnszoneName')]"
                  },
                  {
                    "name": "DNS_ZONE_RESOURCEGROUP_NAME",
                    "value": "[parameters('dnszoneRGName')]"
                  },
                  {
                    "name": "USE_AKS_WELL_TESTED_VERSION",
                    "value": "[string(parameters('useAksWellTestedVersion'))]"
                  },
                  {
                    "name": "VNET_FOR_APPLICATIONGATEWAY",
                    "value": "[string(parameters('vnetForApplicationGateway'))]"
                  }
                ],
                "scriptContent": "[format('{0}\r\n\r\n{1}', '# Copyright (c) 2021, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n\nexport checkPodStatusInterval=20 # interval of checking pod status.\nexport checkPodStatusMaxAttemps=50 # max attempt to check pod status.\nexport checkPVStateInterval=5 # interval of checking pvc status.\nexport checkPVStateMaxAttempt=10 # max attempt to check pvc status.\nexport checkSVCStateMaxAttempt=50\nexport checkSVCInterval=30 #seconds\n\nexport constAdminT3AddressEnvName=\"T3_TUNNELING_ADMIN_ADDRESS\"\nexport constAdminServerName=''admin-server''\nexport constClusterName=''cluster-1''\nexport constClusterT3AddressEnvName=\"T3_TUNNELING_CLUSTER_ADDRESS\"\nexport constDefaultJavaOptions=\"-Dlog4j2.formatMsgNoLookups=true -Dweblogic.StdoutDebugEnabled=false\" # the java options will be applied to the cluster\nexport constDefaultJVMArgs=\"-Djava.security.egd=file:/dev/./urandom -Xms256m -Xmx512m -XX:MinRAMPercentage=25.0 -XX:MaxRAMPercentage=50.0 \" # the JVM options will be applied to the cluster\nexport constDefaultAKSVersion=\"default\"\nexport constFalse=\"false\"\nexport constTrue=\"true\"\nexport constIntrospectorJobActiveDeadlineSeconds=300  # for Guaranteed Qos\nexport constPostgreDriverName=\"postgresql-42.3.6.jar\"\nexport constMSSQLDriverName=\"mssql-jdbc-10.2.1.jre8.jar\"\n\nexport curlMaxTime=120 # seconds\nexport ocrLoginServer=\"container-registry.oracle.com\"\nexport ocrGaImagePath=\"middleware/weblogic\"\nexport ocrCpuImagePath=\"middleware/weblogic_cpu\"\nexport gitUrl4CpuImages=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/weblogic_cpu_images.json\"\nexport gitUrl4AksWellTestedVersionJsonFile=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/aks_well_tested_version.json\"\nexport gitUrl4WLSToolingFamilyJsonFile=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/weblogic_tooling_family.json\"\n\nexport optUninstallMaxTry=5 # Max attempts to wait for the operator uninstalled\nexport optUninstallInterval=10\n\nexport wlsContainerName=\"weblogic-server\"\nexport wlsPostgresqlDriverUrl=\"https://jdbc.postgresql.org/download/postgresql-42.3.6.jar\"\nexport wlsMSSQLDriverUrl=\"https://repo.maven.apache.org/maven2/com/microsoft/sqlserver/mssql-jdbc/10.2.1.jre8/mssql-jdbc-10.2.1.jre8.jar\"\n', '# Copyright (c) 2021, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n#\n# env inputs:\n# ORACLE_ACCOUNT_NAME\n# ORACLE_ACCOUNT_PASSWORD\n# ACR_NAME\n# AKS_CLUSTER_NAME\n# AKS_CLUSTER_RESOURCEGROUP_NAME\n# BASE64_FOR_SERVICE_PRINCIPAL\n# WLS_SSL_KEYVAULT_NAME\n# WLS_SSL_KEYVAULT_RESOURCEGROUP_NAME\n# WLS_SSL_KEYVAULT_IDENTITY_DATA_SECRET_NAME\n# WLS_SSL_KEYVAULT_IDENTITY_PASSWORD_SECRET_NAME\n# WLS_SSL_KEYVAULT_IDENTITY_TYPE\n# WLS_SSL_KEYVAULT_TRUST_DATA_SECRET_NAME\n# WLS_SSL_KEYVAULT_TRUST_PASSWORD_SECRET_NAME\n# WLS_SSL_KEYVAULT_TRUST_TYPE\n# WLS_SSL_KEYVAULT_PRIVATE_KEY_ALIAS\n# WLS_SSL_KEYVAULT_PRIVATE_KEY_PASSWORD\n# WLS_SSL_IDENTITY_DATA\n# WLS_SSL_IDENTITY_PASSWORD\n# WLS_SSL_IDENTITY_TYPE\n# WLS_SSL_TRUST_DATA\n# WLS_SSL_TRUST_PASSWORD\n# WLS_SSL_TRUST_TYPE\n# WLS_SSL_PRIVATE_KEY_ALIAS\n# WLS_SSL_PRIVATE_KEY_PASSWORD\n# APPLICATION_GATEWAY_SSL_KEYVAULT_NAME\n# APPLICATION_GATEWAY_SSL_KEYVAULT_RESOURCEGROUP\n# APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_DATA_SECRET_NAME\n# APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_PASSWORD_SECRET_NAME\n# APPLICATION_GATEWAY_SSL_FRONTEND_CERT_DATA\n# APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD\n# DNS_ZONE_NAME\n# DNS_ZONE_RESOURCEGROUP_NAME\n# AKS_VERSION\n# USE_AKS_WELL_TESTED_VERSION\n# VNET_FOR_APPLICATIONGATEWAY\n\nfunction echo_stderr() {\n  echo \"$@\" 1>&2\n  # The function is used for scripts running within Azure Deployment Script\n  # The value of AZ_SCRIPTS_OUTPUT_PATH is /mnt/azscripts/azscriptoutput\n  echo -e \"$@\" >>${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/errors.log\n}\n\nfunction echo_stdout() {\n  echo \"$@\"\n  # The function is used for scripts running within Azure Deployment Script\n  # The value of AZ_SCRIPTS_OUTPUT_PATH is /mnt/azscripts/azscriptoutput\n  echo -e \"$@\" >>${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/debug.log\n}\n\nfunction install_jdk() {\n    # Install Microsoft OpenJDK\n    apk --no-cache add openjdk11 --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community\n\n    echo \"java version\"\n    java -version\n    if [ $? -eq 1 ]; then\n        echo_stderr \"Failed to install open jdk 11.\"\n        exit 1\n    fi\n    # JAVA_HOME=/usr/lib/jvm/java-11-openjdk\n}\n\n#Validate teminal status with $?, exit with exception if errors happen.\n# $1 - error message\n# $2 -  root cause message\nfunction validate_status() {\n  if [ $? != 0 ]; then\n    echo_stderr \"Errors happen during: $1.\" $2\n    exit 1\n  else\n    echo_stdout \"$1\"\n  fi\n}\n\n# Validate User Assigned Managed Identity\n# Check points:\n#   - the identity is User Assigned Identity, if not, exit with error.\n#   - the identity is assigned with Contributor or Owner role, if not, exit with error.\nfunction validate_user_assigned_managed_identity() {\n  # AZ_SCRIPTS_USER_ASSIGNED_IDENTITY\n  local uamiType=$(az identity show --ids ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY} --query \"type\" -o tsv)\n  validate_status \"query resource type of ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY}\" \"The user managed identity may not exist, please check.\"\n  if [[ \"${uamiType}\" != \"${userManagedIdentityType}\" ]]; then\n    echo_stderr \"You must use User Assigned Managed Identity, please follow the document to create one: https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef\"\n    exit 1\n  fi\n\n  echo_stdout \"query principal Id of the User Assigned Identity.\"\n  local principalId=$(az identity show --ids ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY} --query \"principalId\" -o tsv)\n\n  echo_stdout \"check if the user assigned managed identity has Contributor or Owner role.\"\n  local roleLength=$(az role assignment list --assignee ${principalId} |\n    jq ''[.[] | select(.roleDefinitionName==\"Contributor\" or .roleDefinitionName==\"Owner\")] | length'')\n  if [ ${roleLength} -lt 1 ]; then\n    echo_stderr \"You must grant the User Assigned Managed Identity with at least Contributor role. Please check ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY}\"\n    exit 1\n  fi\n\n  echo_stdout \"Check User Assigned Identity: passed!\"\n}\n\n# Validate compute resources\n# Check points:\n#   - there is enough resource for AKS cluster\n#   - there is enough resource for VM to build the image\n# Example to list the vm usage:\n# az vm list-usage --location \"East US\" -o table\n# Name                                      CurrentValue    Limit\n# ----------------------------------------  --------------  -------\n# Availability Sets                         0               2500\n# Total Regional vCPUs                      2               200\n# Virtual Machines                          1               25000\n# Virtual Machine Scale Sets                0               2500\n# Dedicated vCPUs                           0               3000\n# Cloud Services                            0               2500\n# Total Regional Low-priority vCPUs         0               100\n# Standard DSv2 Family vCPUs                0               100\n# Standard Av2 Family vCPUs                 2               100\n# Basic A Family vCPUs                      0               100\n# Standard A0-A7 Family vCPUs               0               200\n# Standard A8-A11 Family vCPUs              0               100\n# Standard D Family vCPUs                   0               100\n# Standard Dv2 Family vCPUs                 0               100\n# Standard DS Family vCPUs                  0               100\n# Standard G Family vCPUs                   0               100\n# Standard GS Family vCPUs                  0               100\n# Standard F Family vCPUs                   0               100\n# Standard FS Family vCPUs                  0               100\n# ... ...\nfunction validate_compute_resources() {\n  # Resource for ubuntu machine\n  # 2 Standard Av2 Family vCPUs\n\n  # query total cores\n  local vmUsage=$(az vm list-usage -l ${location} -o json)\n  local totalCPUs=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"cores\") | .limit'' | tr -d \"\\\"\")\n  local currentCPUs=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"cores\") | .currentValue'' | tr -d \"\\\"\")\n  local aksCPUs=0\n\n  # if creating new AKS cluster\n  if [[ \"${createAKSCluster,,}\" == \"true\" ]]; then\n    local aksVMDetails=$(az vm list-skus --size ${aksAgentPoolVMSize} -l ${location} --query [0])\n    local vmFamily=$(echo ${aksVMDetails} | jq ''.family'' | tr -d \"\\\"\")\n    local vmCPUs=$(echo ${aksVMDetails} | jq ''.capabilities[] | select(.name==\"vCPUs\") | .value'' | tr -d \"\\\"\")\n    aksCPUs=$((vmCPUs * aksAgentPoolNodeCount))\n\n    # query CPU usage of the vm family\n    local familyLimit=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"''${vmFamily}''\") | .limit'' | tr -d \"\\\"\")\n    local familyUsage=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"''${vmFamily}''\") | .currentValue'' | tr -d \"\\\"\")\n    local requiredFamilyCPUs=$((aksCPUs + familyUsage))\n    # make sure thers is enough vCPUs of the family for AKS\n    if [ ${requiredFamilyCPUs} -gt ${familyLimit} ]; then\n      echo_stderr \"It requires ${aksCPUs} ${vmFamily} vCPUs to create the AKS cluster, ${vmFamily} vCPUs quota is limited to ${familyLimit}, current usage is ${familyUsage}.\"\n      exit 1\n    fi\n  fi\n\n  local vmFamilyOfUbuntu=\"standardAv2Family\"\n  local familyLimit=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"''${vmFamilyOfUbuntu}''\") | .limit'' | tr -d \"\\\"\")\n  local familyUsage=$(echo ${vmUsage} | jq ''.[] | select(.name.value==\"''${vmFamilyOfUbuntu}''\") | .currentValue'' | tr -d \"\\\"\")\n  local requiredFamilyCPUs=$((2 + familyUsage))\n  # make sure thers is enough vCPUs of the family for ubuntu machine\n  if [ ${requiredFamilyCPUs} -gt ${familyLimit} ]; then\n      echo_stderr \"It requires 2 ${vmFamilyOfUbuntu} vCPUs to create an ubuntu machine for docker image, ${vmFamilyOfUbuntu} vCPUs quota is limited to ${familyLimit}, current usage is ${familyUsage}.\"\n      exit 1\n  fi\n\n  local requiredCPU=$((aksCPUs + 2 + currentCPUs))\n  if [ ${requiredCPU} -gt ${totalCPUs} ]; then\n      echo_stderr \"It requires ${requiredCPU} vCPUs to run WLS on AKS, vCPUs quota is limited to ${totalCPUs}, current usage is ${currentCPUs}.\"\n      exit 1\n  fi\n\n  echo_stdout \"Check compute resources: passed!\"\n}\n\nfunction validate_ocr_account() {\n  # install docker cli\n  apk add docker --no-cache --quiet\n  docker --help\n  validate_status \"install docker\"\n\n  # ORACLE_ACCOUNT_NAME\n  # ORACLE_ACCOUNT_PASSWORD\n  docker logout\n  echo \"${ORACLE_ACCOUNT_PASSWORD}\" | docker login ${ocrLoginServer} -u ${ORACLE_ACCOUNT_NAME} --password-stdin\n  validate_status \"login OCR with user ${ORACLE_ACCOUNT_NAME}\"\n\n  echo_stdout \"Check OCR account: passed!\"\n}\n\nfunction validate_ocr_image() {\n  local ocrImageFullPath=\"${ocrLoginServer}/${ocrGaImagePath}:${wlsImageTag}\"\n\n  if [[ \"${ORACLE_ACCOUNT_ENTITLED,,}\" == \"true\" ]]; then\n\n    # download the ga cpu image mapping file.\n    local cpuImagesListFile=weblogic_cpu_images.json\n    curl -L \"${gitUrl4CpuImages}\" -o ${cpuImagesListFile}\n    local cpuTag=$(cat ${cpuImagesListFile} | jq \".items[] | select(.gaTag == \\\"${wlsImageTag}\\\") | .cpuTag\" | tr -d \"\\\"\")\n    echo_stdout \"cpu tag: ${cpuTag}\"\n    # if we can not find a matched image, keep the input tag.\n    if [[ \"${cpuTag}\" == \"\" ||  \"${cpuTag,,}\" == \"null\" ]]; then\n      cpuTag=${wlsImageTag}\n    fi\n\n    ocrImageFullPath=\"${ocrLoginServer}/${ocrCpuImagePath}:${cpuTag}\"\n  fi\n\n  echo_stdout \"image path: ${ocrImageFullPath}\"\n\n  # validate the image by importing it to ACR.\n  # if failure happens, the image should be unavailable\n  local tmpImagePath=\"tmp$(date +%s):${wlsImageTag}\"\n  az acr import --name ${ACR_NAME} \\\n    --source ${ocrImageFullPath} \\\n    -u ${ORACLE_ACCOUNT_NAME} \\\n    -p ${ORACLE_ACCOUNT_PASSWORD} \\\n    --image ${tmpImagePath} \\\n    --only-show-errors\n\n  # $? equals 0 even though failure happens.\n  # check if the image is imported successfully.\n  local ret=$(az acr repository show --name $ACR_NAME --image ${tmpImagePath})\n  if [ -n \"${ret}\" ]; then\n    # delete the image from ACR.\n    az acr repository delete --name ${ACR_NAME} --image ${tmpImagePath} --yes\n  else\n    echo_stderr $ret\n    echo_stderr \"\"\n    echo_stderr \"Image ${ocrImageFullPath} is not available! Please make sure you have accepted the Oracle Standard Terms and Restrictions and the image exists in https://container-registry.oracle.com/ \"\n    if [[ \"${ORACLE_ACCOUNT_ENTITLED,,}\" == \"true\" ]]; then\n      echo_stderr \"Make sure you are entitled to access middleware/weblogic_cpu repository.\"\n    fi\n\n    exit 1\n  fi\n\n  echo_stdout \"Check OCR image ${ocrImageFullPath}: passed!\"\n}\n\nfunction check_acr_admin_enabled() {\n  local acrName = $1\n  echo_stdout \"check if admin user enabled in ACR $acrName \"\n  local adminUserEnabled=$(az acr show --name $acrName --query \"adminUserEnabled\")\n  validate_status \"query ''adminUserEnabled'' property of ACR ${acrName}\" \"Invalid ACR: ${acrName}\"\n\n  if [[ \"${adminUserEnabled}\" == \"false\" ]]; then\n    echo_stderr \"Make sure admin user is enabled in ACR $acrName. Please find steps in https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef&tabs=azure-cli#admin-account\"\n    exit 1\n  fi\n}\n\nfunction validate_acr_image() {\n  echo_stdout \"user provided ACR: $ACR_NAME_FOR_USER_PROVIDED_IMAGE\"\n\n  local pathWithoutTag=${userProvidedImagePath%\\:*}\n  local repository=${pathWithoutTag#*\\/}\n  local tag=\"${userProvidedImagePath##*:}\"\n\n  local tagIndex=$(az acr repository show-tags --name $ACR_NAME_FOR_USER_PROVIDED_IMAGE --repository ${repository} | jq ''index(\"''${tag}''\")'')\n  validate_status \"check if tag ${tag} exists.\" \"Invalid image path ${userProvidedImagePath}\"\n  if [[ \"${tagIndex}\" == \"null\" ]]; then\n    echo_stderr \"Image ${tag} does not exist in ${repository}.\"\n    exit 1\n  fi\n\n  echo_stdout \"Check ACR image: passed!\"\n}\n\nfunction validate_base_image_path() {\n  if [[ \"${useOracleImage,,}\" == \"true\" ]]; then\n    validate_ocr_account\n    validate_ocr_image\n  else\n    validate_acr_image\n  fi\n}\n\nfunction validate_acr_admin_enabled()\n{\n  if [[ \"${useOracleImage,,}\" == \"true\" ]]; then\n    check_acr_admin_enabled ${ACR_NAME}\n  else\n    check_acr_admin_enabled ${ACR_NAME_FOR_USER_PROVIDED_IMAGE}\n  fi\n}\n\n# Only support kubenet currently\nfunction validate_aks_network_plugin() {\n  # AKS_CLUSTER_NAME\n  # AKS_CLUSTER_RESOURCEGROUP_NAME\n\n  if [[ \"${createAKSCluster,,}\" == \"false\" ]]; then\n    local networkPlugin=$(az aks show -n ${AKS_CLUSTER_NAME} \\\n      -g ${AKS_CLUSTER_RESOURCEGROUP_NAME} \\\n      --query ''networkProfile.networkPlugin'' -o tsv)\n\n    if [[ \"${networkPlugin}\" != \"kubenet\" ]]; then\n      echo_stderr \"The offer only supports AKS network type kubenet, you are using a cluster of CNI.\"\n      exit 1\n    fi\n  fi\n\n  echo_stdout \"Check AKS networking: passed!\"\n}\n\nfunction download_wls_ssl_certificates_from_keyvault() {\n  # check key vault accessibility for template deployment\n  local enabledForTemplateDeployment=$(az keyvault show --name ${WLS_SSL_KEYVAULT_NAME} --query \"properties.enabledForTemplateDeployment\")\n  if [[ \"${enabledForTemplateDeployment,,}\" != \"true\" ]]; then\n    echo_stderr \"Make sure Key Vault ${WLS_SSL_KEYVAULT_NAME} is enabled for template deployment. \"\n    exit 1\n  fi\n\n  # allow the identity to access the keyvault\n  local principalId=$(az identity show --ids ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY} --query \"principalId\" -o tsv)\n  az keyvault set-policy --name ${WLS_SSL_KEYVAULT_NAME}  --object-id ${principalId} --secret-permissions get list\n  validate_status \"grant identity permission to get/list secrets in key vault ${WLS_SSL_KEYVAULT_NAME}\"\n\n  local identityDataFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/identityData.txt\n  local identityPswFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/identityPsw.txt\n  local trustDataFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/trustData.txt\n  local trustPswFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/trustPsw.txt\n  local privateKeyAliasFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/privateKeyData.txt\n  local privateKeyPswFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/privateKeyPsw.txt\n\n  rm -f ${identityDataFileName}\n  rm -f ${identityPswFileName}\n  rm -f ${trustDataFileName}\n  rm -f ${trustPswFileName}\n  rm -f ${privateKeyAliasFileName}\n  rm -f ${privateKeyPswFileName}\n\n  # download identity data\n  az keyvault secret download --file ${identityDataFileName} \\\n    --name ${WLS_SSL_KEYVAULT_IDENTITY_DATA_SECRET_NAME} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_IDENTITY_DATA_SECRET_NAME} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set identity data with values in download file\n  WLS_SSL_IDENTITY_DATA=$(cat ${identityDataFileName})\n  # remove the data file\n  rm -f ${identityDataFileName}\n\n  # download identity password\n  az keyvault secret download --file ${identityPswFileName} \\\n    --name ${WLS_SSL_KEYVAULT_IDENTITY_PASSWORD_SECRET_NAME} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_IDENTITY_PASSWORD_SECRET_NAME} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set identity psw with values in download file\n  WLS_SSL_IDENTITY_PASSWORD=$(cat ${identityPswFileName})\n  # remove the data file\n  rm -f ${identityPswFileName}\n\n  # download trust data\n  az keyvault secret download --file ${trustDataFileName} \\\n    --name ${WLS_SSL_KEYVAULT_TRUST_DATA_SECRET_NAME} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_TRUST_DATA_SECRET_NAME} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set trust data with values in download file\n  WLS_SSL_TRUST_DATA=$(cat ${trustDataFileName})\n  # remove the data file\n  rm -f ${trustDataFileName}\n\n  # download trust psw\n  az keyvault secret download --file ${trustPswFileName} \\\n    --name ${WLS_SSL_KEYVAULT_TRUST_PASSWORD_SECRET_NAME} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_TRUST_PASSWORD_SECRET_NAME} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set trust psw with values in download file\n  WLS_SSL_TRUST_PASSWORD=$(cat ${trustPswFileName})\n  # remove the data file\n  rm -f ${trustPswFileName}\n\n  # download alias\n  az keyvault secret download --file ${privateKeyAliasFileName} \\\n    --name ${WLS_SSL_KEYVAULT_PRIVATE_KEY_ALIAS} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_PRIVATE_KEY_ALIAS} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set alias with values in download file\n  WLS_SSL_PRIVATE_KEY_ALIAS=$(cat ${privateKeyAliasFileName})\n  # remove the data file\n  rm -f ${privateKeyAliasFileName}\n\n  # download private key psw\n  az keyvault secret download --file ${privateKeyPswFileName} \\\n    --name ${WLS_SSL_KEYVAULT_PRIVATE_KEY_PASSWORD} \\\n    --vault-name ${WLS_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${WLS_SSL_KEYVAULT_PRIVATE_KEY_PASSWORD} from key vault ${WLS_SSL_KEYVAULT_NAME}\"\n  # set private key psw with values in download file\n  WLS_SSL_PRIVATE_KEY_PASSWORD=$(cat ${privateKeyPswFileName})\n  # remove the data file\n  rm -f ${privateKeyPswFileName}\n\n  WLS_SSL_IDENTITY_TYPE=${WLS_SSL_KEYVAULT_IDENTITY_TYPE}\n  WLS_SSL_TRUST_TYPE=${WLS_SSL_KEYVAULT_TRUST_TYPE}\n\n  # reset key vault policy\n  az keyvault delete-policy --name ${WLS_SSL_KEYVAULT_NAME}  --object-id ${principalId}\n  validate_status \"delete identity permission to get/list secrets in key vault ${WLS_SSL_KEYVAULT_NAME}\"\n}\n\nfunction validate_wls_ssl_certificates() {\n  if [[ \"${sslConfigurationAccessOption}\" == \"${sslCertificateKeyVaultOption}\" ]]; then\n    download_wls_ssl_certificates_from_keyvault\n  fi\n\n  local wlsIdentityKeyStoreFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/identity.keystore\n  local wlsTrustKeyStoreFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/trust.keystore\n  echo \"$WLS_SSL_IDENTITY_DATA\" | base64 -d >$wlsIdentityKeyStoreFileName\n  echo \"$WLS_SSL_TRUST_DATA\" | base64 -d >$wlsTrustKeyStoreFileName\n\n  # use default Java, if no, install open jdk 11.\n  # why not using Microsoft open jdk? \n  # No apk installation package!\n  export JAVA_HOME=/usr/lib/jvm/default-jvm/\n  if [ ! -d \"${JAVA_HOME}\" ]; then\n      install_jdk\n      JAVA_HOME=/usr/lib/jvm/java-11-openjdk\n  fi\n  #validate if identity keystore has entry\n  ${JAVA_HOME}/bin/keytool -list -v \\\n      -keystore $wlsIdentityKeyStoreFileName \\\n      -storepass $WLS_SSL_IDENTITY_PASSWORD \\\n      -storetype $WLS_SSL_IDENTITY_TYPE |\n      grep ''Entry type:'' |\n      grep ''PrivateKeyEntry''\n\n  validate_status \"validate Identity Keystore.\"\n\n  #validate if trust keystore has entry\n  ${JAVA_HOME}/bin/keytool -list -v \\\n      -keystore ${wlsTrustKeyStoreFileName} \\\n      -storepass $WLS_SSL_TRUST_PASSWORD \\\n      -storetype $WLS_SSL_TRUST_TYPE |\n      grep ''Entry type:'' |\n      grep ''trustedCertEntry''\n\n  validate_status \"validate Trust Keystore.\"\n\n  echo_stdout \"validate SSL key stores: passed!\"\n}\n\nfunction download_application_gateway_certificate_from_keyvault() {\n  # check key vault accessibility for template deployment\n  local enabledForTemplateDeployment=$(az keyvault show --name ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME} --query \"properties.enabledForTemplateDeployment\")\n  if [[ \"${enabledForTemplateDeployment,,}\" != \"true\" ]]; then\n    echo_stderr \"Make sure Key Vault ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME} is enabled for template deployment. \"\n    exit 1\n  fi\n\n  # allow the identity to access the keyvault\n  local principalId=$(az identity show --ids ${AZ_SCRIPTS_USER_ASSIGNED_IDENTITY} --query \"principalId\" -o tsv)\n  az keyvault set-policy --name ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}  --object-id ${principalId} --secret-permissions get list\n  validate_status \"grant identity permission to get/list secrets in key vault ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}\"\n\n  local gatewayCertDataFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/gatewayCertData.txt\n  local gatewayCertPswFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/gatewayCertPsw.txt\n\n  rm -f ${gatewayCertDataFileName}\n  rm -f ${gatewayCertPswFileName}\n\n  # download cert data\n  az keyvault secret download --file ${gatewayCertDataFileName} \\\n    --name ${APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_DATA_SECRET_NAME} \\\n    --vault-name ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}\n  validate_status \"download secret ${APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_DATA_SECRET_NAME} from key vault ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}\"\n  # set cert data with values in download file\n  APPLICATION_GATEWAY_SSL_FRONTEND_CERT_DATA=$(cat ${gatewayCertDataFileName})\n  # remove the data file\n  rm -f ${gatewayCertDataFileName}\n\n  # download cert data\n  az keyvault secret download --file ${gatewayCertPswFileName} \\\n    --name ${APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_PASSWORD_SECRET_NAME} \\\n    --vault-name ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME} \n  validate_status \"download secret ${APPLICATION_GATEWAY_SSL_KEYVAULT_FRONTEND_CERT_PASSWORD_SECRET_NAME} from key vault ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}\"\n  # set cert data with values in download file\n  APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD=$(cat ${gatewayCertPswFileName})\n  # remove the data file\n  rm -f ${gatewayCertPswFileName}\n\n  # reset key vault policy\n  az keyvault delete-policy --name ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}  --object-id ${principalId}\n  validate_status \"delete identity permission to get/list secrets in key vault ${APPLICATION_GATEWAY_SSL_KEYVAULT_NAME}\"\n}\n\nfunction validate_gateway_frontend_certificates() {\n  if [[ \"${appGatewayCertificateOption}\" == \"generateCert\" ]]; then\n    return\n  fi\n\n  if [[ \"${appGatewayCertificateOption}\" == \"haveKeyVault\" ]]; then\n    download_application_gateway_certificate_from_keyvault\n  fi\n\n  local appgwFrontCertFileName=${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/gatewaycert.pfx\n  echo \"$APPLICATION_GATEWAY_SSL_FRONTEND_CERT_DATA\" | base64 -d >$appgwFrontCertFileName\n\n  openssl pkcs12 \\\n    -in $appgwFrontCertFileName \\\n    -nocerts \\\n    -out ${AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY}/cert.key \\\n    -passin pass:${APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD} \\\n    -passout pass:${APPLICATION_GATEWAY_SSL_FRONTEND_CERT_PASSWORD}\n  \n  validate_status \"access application gateway frontend key.\" \"Make sure the Application Gateway frontend certificate is correct.\"\n}\n\nfunction validate_service_principal() {\n  local spObject=$(echo \"${BASE64_FOR_SERVICE_PRINCIPAL}\" | base64 -d)\n  validate_status \"decode the service principal base64 string.\" \"Invalid service principal.\"\n\n  # for sdk format string\n  # {\n  #   \"clientId\": \"3082055e-dd40-452d-9190-xxxxxxx\",\n  #   \"clientSecret\": \"uh0sZPoNsLKyUU3iOO1~xxxxxxx\",\n  #   \"subscriptionId\": \"260524c9-7a4d-4483-8d85-xxxxxxx\",\n  #   \"tenantId\": \"814a03f9-f7c3-41a4-8ecc-xxxxxxx\",\n  #   \"activeDirectoryEndpointUrl\": \"https://xxxxx.com\",\n  #   \"resourceManagerEndpointUrl\": \"https://xxxxx.com/\",\n  #   \"activeDirectoryGraphResourceId\": \"https://xxxxx.net/\",\n  #   \"sqlManagementEndpointUrl\": \"https://xxxxx.net:8443/\",\n  #   \"galleryEndpointUrl\": \"https://xxxxx.com/\",\n  #   \"managementEndpointUrl\": \"https://xxxxx.net/\"\n  # }\n  local principalId=$(echo ${spObject} | jq ''.clientId'')\n  validate_status \"get client id from the service principal.\" \"Invalid service principal.\"\n\n  if [[ \"${principalId}\" == \"null\" ]] || [[ \"${principalId}\" == \"\" ]]; then\n    echo_stderr \"the service principal is invalid.\"\n    exit 1\n  fi\n\n  echo_stdout \"check if the service principal has Contributor or Owner role.\"\n  local roleLength=$(az role assignment list --assignee ${principalId} |\n    jq ''[.[] | select(.roleDefinitionName==\"Contributor\" or .roleDefinitionName==\"Owner\")] | length'')\n  \n  # skip error like: \n  #    Cannot find user or service principal in graph database for ''\"3082055e-dd40-452d-9190-xxxxxxx\"''. \n  #    If the assignee is an appId, make sure the corresponding service principal is created with ''az ad sp create --id \"3082055e-dd40-452d-9190-xxxxxxx\"''.\n  local re=''^[0-9]+$''\n  if ! [[ $roleLength =~ $re ]] ; then\n    echo_stderr \"You must grant the service principal with at least Contributor role.\"\n  fi\n\n  if [ ${roleLength} -lt 1 ]; then\n    echo_stderr \"You must grant the service principal with at least Contributor role.\"\n  fi\n\n  echo_stdout \"Check service principal: passed!\"\n}\n\nfunction validate_dns_zone() {\n  if [[ \"${checkDNSZone,,}\" == \"true\" ]]; then\n    az network dns zone show -n ${DNS_ZONE_NAME} -g ${DNS_ZONE_RESOURCEGROUP_NAME}\n    validate_status \"check DNS Zone ${DNS_ZONE_NAME}\" \"Make sure the DNS Zone exists.\"\n\n    echo_stdout \"Check DNS Zone: passed!\"\n  fi\n}\n\nfunction validate_aks_version() {\n  if [[ \"${USE_AKS_WELL_TESTED_VERSION,,}\" == \"true\" ]]; then\n    local aksWellTestedVersionFile=aks_well_tested_version.json\n    # download the json file that has well-tested version from weblogic-azure repo.\n    curl -L \"${gitUrl4AksWellTestedVersionJsonFile}\" -o ${aksWellTestedVersionFile}\n    local aksWellTestedVersion=$(cat ${aksWellTestedVersionFile} | jq  \".value\" | tr -d \"\\\"\")\n    echo \"AKS well-tested version: ${aksWellTestedVersion}\"\n    # check if the well-tested version is supported in the location\n    local ret=$(az aks get-versions --location ${location} \\\n      | jq \".orchestrators[] | select(.orchestratorVersion == \\\"${aksWellTestedVersion}\\\") | .orchestratorVersion\" \\\n      | tr -d \"\\\"\")\n    if [[ \"${aksWellTestedVersion}\" !=  \"\" ]] && [[ \"${ret}\" ==  \"${aksWellTestedVersion}\" ]]; then\n      outputAksVersion=${aksWellTestedVersion}\n    else\n      # if the well-tested version is invalid, use default version.\n      outputAksVersion=${constDefaultAKSVersion}\n    fi\n  else\n    # check if the input version is supported in the location\n    local ret=$(az aks get-versions --location ${location} \\\n      | jq \".orchestrators[] | select(.orchestratorVersion == \\\"${AKS_VERSION}\\\") | .orchestratorVersion\" \\\n      | tr -d \"\\\"\")\n    if [[ \"${ret}\" ==  \"${AKS_VERSION}\" ]]; then\n      outputAksVersion=${AKS_VERSION}\n    else\n      echo_stderr \"ERROR: invalid aks version ${AKS_VERSION} in ${location}.\"\n      exit 1\n    fi\n  fi\n}\n\n# VNET input sample:\n# {\n#     \"name\": \"wlsaks-vnet\",\n#     \"resourceGroup\": \"haiche-test\",\n#     \"addressPrefixes\": [\n#         \"10.3.0.0/28\"\n#     ],\n#     \"addressPrefix\": \"10.3.0.0/28\",\n#     \"newOrExisting\": \"new\",\n#     \"subnets\": {\n#         \"gatewaySubnet\": {\n#             \"name\": \"wls-aks-gateway-subnet\",\n#             \"addressPrefix\": \"10.3.0.0/29\",\n#             \"startAddress\": \"10.3.0.4\"\n#         }\n#     }\n# }\n# To make sure the subnet only have application gateway\nfunction validate_appgateway_vnet() {\n  echo_stdout \"VNET for application gateway: ${VNET_FOR_APPLICATIONGATEWAY}\"\n  local vnetName=$(echo ${VNET_FOR_APPLICATIONGATEWAY} | jq ''.name'' | tr -d \"\\\"\")\n  local vnetResourceGroup=$(echo ${VNET_FOR_APPLICATIONGATEWAY} | jq ''.resourceGroup'' | tr -d \"\\\"\")\n  local newOrExisting=$(echo ${VNET_FOR_APPLICATIONGATEWAY} | jq ''.newOrExisting'' | tr -d \"\\\"\")\n  local subnetName=$(echo ${VNET_FOR_APPLICATIONGATEWAY} | jq ''.subnets.gatewaySubnet.name'' | tr -d \"\\\"\")\n\n  if [[ \"${newOrExisting,,}\" != \"new\" ]]; then\n    # the subnet can only have Application Gateway.\n    # query ipConfigurations:\n    # if lenght of ipConfigurations is greater than 0, the subnet fails to meet requirement of Application Gateway.\n    local ret=$(az network vnet show \\\n      -g ${vnetResourceGroup} \\\n      --name ${vnetName} \\\n      | jq \".subnets[] | select(.name==\\\"${subnetName}\\\") | .ipConfigurations | length\")\n    \n    if [ $ret -gt 0 ]; then\n      echo_stderr \"ERROR: invalid subnet for Application Gateway, the subnet has ${ret} connected device(s). Make sure the subnet is only for Application Gateway.\"\n      exit 1\n    fi\n  fi\n}\n\nfunction output_result() {\n  echo \"AKS version: ${outputAksVersion}\"\n  result=$(jq -n -c \\\n    --arg aksVersion \"$outputAksVersion\" \\\n    ''{aksVersion: $aksVersion}'')\n  echo \"result is: $result\"\n  echo $result >$AZ_SCRIPTS_OUTPUT_PATH\n}\n\n# main\nlocation=$1\ncreateAKSCluster=$2\naksAgentPoolVMSize=$3\naksAgentPoolNodeCount=$4\nuseOracleImage=$5\nwlsImageTag=$6\nuserProvidedImagePath=$7\nenableCustomSSL=$8\nsslConfigurationAccessOption=$9\nappGatewayCertificateOption=${10}\nenableAppGWIngress=${11}\ncheckDNSZone=${12}\n\noutputAksVersion=${constDefaultAKSVersion}\nsslCertificateKeyVaultOption=\"keyVaultStoredConfig\"\nuserManagedIdentityType=\"Microsoft.ManagedIdentity/userAssignedIdentities\"\n\nvalidate_user_assigned_managed_identity\n\nvalidate_compute_resources\n\nvalidate_base_image_path\n\nvalidate_acr_admin_enabled\n\nvalidate_aks_network_plugin\n\nif [[ \"${enableCustomSSL,,}\" == \"true\" ]]; then\n  validate_wls_ssl_certificates\nfi\n\nif [[ \"${enableAppGWIngress,,}\" == \"true\" ]]; then\n  validate_gateway_frontend_certificates\n  validate_service_principal\nfi\n\nvalidate_dns_zone\n\nif [[ \"${createAKSCluster,,}\" == \"true\" ]]; then\n  validate_aks_version\nfi\n\nvalidate_appgateway_vnet\n\noutput_result\n\n')]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "aksVersion": {
              "type": "string",
              "value": "[reference(variables('const_deploymentName')).outputs.aksVersion]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]"
      ]
    },
    {
      "condition": "[and(parameters('enableCustomSSL'), not(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "upload-wls-ssl-cert-to-keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('name_keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('keyVaultSku')]"
          },
          "wlsIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "wlsIdentityKeyStoreDataSecretName": {
            "value": "[variables('name_identityKeyStoreDataSecret')]"
          },
          "wlsIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "wlsIdentityKeyStorePassphraseSecretName": {
            "value": "[variables('name_identityKeyStorePswSecret')]"
          },
          "wlsPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "wlsPrivateKeyAliasSecretName": {
            "value": "[variables('name_privateKeyAliasSecret')]"
          },
          "wlsPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "wlsPrivateKeyPassPhraseSecretName": {
            "value": "[variables('name_privateKeyPswSecret')]"
          },
          "wlsTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "wlsTrustKeyStoreDataSecretName": {
            "value": "[variables('name_trustKeyStoreDataSecret')]"
          },
          "wlsTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "wlsTrustKeyStorePassPhraseSecretName": {
            "value": "[variables('name_trustKeyStorePswSecret')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "3588284649734005005"
            }
          },
          "parameters": {
            "enabledForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the vault"
              }
            },
            "location": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "Price tier for Key Vault."
              }
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreDataSecretName": {
              "type": "string",
              "defaultValue": "myIdentityKeyStoreData"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphraseSecretName": {
              "type": "string",
              "defaultValue": "myIdentityKeyStorePsw"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyAliasSecretName": {
              "type": "string",
              "defaultValue": "privateKeyAlias"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhraseSecretName": {
              "type": "string",
              "defaultValue": "privateKeyPsw"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreDataSecretName": {
              "type": "string",
              "defaultValue": "myTrustKeyStoreData"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhraseSecretName": {
              "type": "string",
              "defaultValue": "myTrustKeyStorePsw"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-10-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "accessPolicies": [],
                "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                "sku": {
                  "name": "[parameters('sku')]",
                  "family": "A"
                },
                "tenantId": "[subscription().tenantId]"
              },
              "tags": {
                "managed-by-azure-weblogic": "[parameters('utcValue')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsIdentityKeyStoreDataSecretName'))]",
              "properties": {
                "value": "[parameters('wlsIdentityKeyStoreData')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsIdentityKeyStorePassphraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsPrivateKeyAliasSecretName'))]",
              "properties": {
                "value": "[parameters('wlsPrivateKeyAlias')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsPrivateKeyPassPhraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsPrivateKeyPassPhrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsTrustKeyStoreDataSecretName'))]",
              "properties": {
                "value": "[parameters('wlsTrustKeyStoreData')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('wlsTrustKeyStorePassPhraseSecretName'))]",
              "properties": {
                "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]"
      ]
    },
    {
      "condition": "[not(parameters('createAKSCluster'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "query-existing-storage-account",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "15333090462078051256"
            }
          },
          "parameters": {
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object"
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "functions": [],
          "variables": {
            "const_arguments": "[format('{0} {1}', parameters('aksClusterRGName'), parameters('aksClusterName'))]",
            "const_azcliVersion": "2.15.0",
            "const_deploymentName": "ds-query-storage-account"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[variables('const_deploymentName')]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[variables('const_azcliVersion')]",
                "arguments": "[variables('const_arguments')]",
                "scriptContent": "export aksClusterRGName=$1\nexport aksClusterName=$2\n\nexport currentStorageAccount=\"null\"\n\n# Connect to AKS cluster\nfunction connect_aks_cluster() {\n  az aks get-credentials \\\n    --resource-group ${aksClusterRGName} \\\n    --name ${aksClusterName} \\\n    --overwrite-existing\n}\n\nfunction query_storage_account() {\n  echo \"install kubectl\"\n  az aks install-cli\n\n  echo \"get pv name\"\n  pvName=$(kubectl get pv -o json |\n    jq '.items[] | select(.status.phase==\"Bound\") | [.metadata.name] | .[0]' |\n    tr -d \"\\\"\")\n\n  if [[ \"${pvName}\" != \"null\" ]] && [[ \"${pvName}\" != \"\" ]]; then\n    # this is a workaround for update domain using marketplace offer.\n    # the offer will create a new storage account in a new resource group if there is no storage attached.\n    currentStorageAccount=$(kubectl get pv ${pvName} -o json | jq '. | .metadata.labels.storageAccount' | tr -d \"\\\"\")\n  fi\n}\n\nfunction output_result() {\n  echo ${currentStorageAccount}\n\n  result=$(jq -n -c \\\n    --arg storageAccount $currentStorageAccount \\\n    '{storageAccount: $storageAccount}')\n  echo \"result is: $result\"\n  echo $result >$AZ_SCRIPTS_OUTPUT_PATH\n}\n\nconnect_aks_cluster\n\nquery_storage_account\n\noutput_result\n",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "storageAccount": {
              "type": "string",
              "value": "[string(reference(variables('const_deploymentName')).outputs.storageAccount)]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableAppGWIngress')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "vnet-application-gateway",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "newOrExistingVnetForApplicationGateway": {
            "value": "[parameters('newOrExistingVnetForApplicationGateway')]"
          },
          "vnetForApplicationGateway": {
            "value": "[parameters('vnetForApplicationGateway')]"
          },
          "vnetRGNameForApplicationGateway": {
            "value": "[parameters('vnetRGNameForApplicationGateway')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "7383393922599587599"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "newOrExistingVnetForApplicationGateway": {
              "type": "string"
            },
            "vnetForApplicationGateway": {
              "type": "object",
              "defaultValue": {
                "name": "wlsaks-app-gateway-vnet",
                "resourceGroup": "[resourceGroup().name]",
                "addressPrefixes": [
                  "172.16.0.0/24"
                ],
                "addressPrefix": "172.16.0.0/24",
                "newOrExisting": "new",
                "subnets": {
                  "gatewaySubnet": {
                    "name": "wlsaks-gateway-subnet",
                    "addressPrefix": "172.16.0.0/24",
                    "startAddress": "172.16.0.4"
                  }
                }
              }
            },
            "vnetRGNameForApplicationGateway": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            }
          },
          "functions": [],
          "variables": {
            "const_subnetAddressPrefixes": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.addressPrefix]",
            "const_vnetAddressPrefixes": "[parameters('vnetForApplicationGateway').addressPrefixes]",
            "const_newVnet": "[if(equals(parameters('vnetForApplicationGateway').newOrExisting, 'new'), true(), false())]",
            "name_nsg": "[format('wlsaks-nsg-{0}', uniqueString(parameters('utcValue')))]",
            "name_subnet": "[parameters('vnetForApplicationGateway').subnets.gatewaySubnet.name]",
            "name_vnet": "[parameters('vnetForApplicationGateway').name]"
          },
          "resources": [
            {
              "condition": "[variables('const_newVnet')]",
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-08-01",
              "name": "[variables('name_nsg')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "65200-65535",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 500,
                      "direction": "Inbound"
                    },
                    "name": "ALLOW_APPGW"
                  },
                  {
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 510,
                      "direction": "Inbound",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ]
                    },
                    "name": "ALLOW_HTTP_ACCESS"
                  }
                ]
              }
            },
            {
              "condition": "[variables('const_newVnet')]",
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-08-01",
              "name": "[variables('name_vnet')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": "[variables('const_vnetAddressPrefixes')]"
                },
                "subnets": [
                  {
                    "name": "[variables('name_subnet')]",
                    "properties": {
                      "addressPrefix": "[variables('const_subnetAddressPrefixes')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('name_nsg'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('name_nsg'))]"
              ]
            }
          ],
          "outputs": {
            "subIdForApplicationGateway": {
              "type": "string",
              "value": "[if(variables('const_newVnet'), resourceId('Microsoft.Network/virtualNetworks/subnets', variables('name_vnet'), variables('name_subnet')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetForApplicationGateway').resourceGroup), 'Microsoft.Network/virtualNetworks/subnets', variables('name_vnet'), variables('name_subnet')))]"
            },
            "vnetResourceGroupName": {
              "type": "string",
              "value": "[parameters('vnetRGNameForApplicationGateway')]"
            },
            "newOrExisting": {
              "type": "string",
              "value": "[parameters('newOrExistingVnetForApplicationGateway')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]"
      ]
    },
    {
      "condition": "[not(parameters('enableCustomSSL'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "setup-wls-cluster",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSEnd.value)]"
          },
          "_pidStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSStart.value)]"
          },
          "aciResourcePermissions": {
            "value": "[parameters('aciResourcePermissions')]"
          },
          "aciRetentionInDays": {
            "value": "[parameters('aciRetentionInDays')]"
          },
          "aciWorkspaceSku": {
            "value": "[parameters('aciWorkspaceSku')]"
          },
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment'), '2019-10-01').outputs.acrName.value]"
          },
          "aksAgentPoolName": {
            "value": "[parameters('aksAgentPoolName')]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "aksAgentPoolVMSize": {
            "value": "[parameters('aksAgentPoolVMSize')]"
          },
          "aksClusterNamePrefix": {
            "value": "[parameters('aksClusterNamePrefix')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast'), '2019-10-01').outputs.aksVersion.value]"
          },
          "appPackageUrls": {
            "value": "[parameters('appPackageUrls')]"
          },
          "appReplicas": {
            "value": "[parameters('appReplicas')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createStorageAccount": {
            "value": "[and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))))), variables('const_enablePV'))]"
          },
          "dbDriverLibrariesUrls": {
            "value": "[parameters('dbDriverLibrariesUrls')]"
          },
          "enableAzureMonitoring": {
            "value": "[parameters('enableAzureMonitoring')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableAdminT3Tunneling": {
            "value": "[parameters('enableAdminT3Tunneling')]"
          },
          "enableClusterT3Tunneling": {
            "value": "[parameters('enableClusterT3Tunneling')]"
          },
          "enablePV": {
            "value": "[variables('const_enablePV')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "managedServerPrefix": {
            "value": "[parameters('managedServerPrefix')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "storageAccountName": {
            "value": "[if(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))), reference('query-existing-storage-account').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue'))))]"
          },
          "t3ChannelAdminPort": {
            "value": "[parameters('t3ChannelAdminPort')]"
          },
          "t3ChannelClusterPort": {
            "value": "[parameters('t3ChannelClusterPort')]"
          },
          "wdtRuntimePassword": {
            "value": "[parameters('wdtRuntimePassword')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "wlsClusterSize": {
            "value": "[parameters('wlsClusterSize')]"
          },
          "wlsCPU": {
            "value": "[parameters('wlsCPU')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsIdentityKeyStoreData": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStoreData')]"
          },
          "wlsIdentityKeyStorePassphrase": {
            "value": "[parameters('sslUploadedCustomIdentityKeyStorePassphrase')]"
          },
          "wlsIdentityKeyStoreType": {
            "value": "[variables('const_defaultKeystoreType')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          },
          "wlsJavaOption": {
            "value": "[variables('const_wlsJavaOptions')]"
          },
          "wlsMemory": {
            "value": "[parameters('wlsMemory')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsPrivateKeyAlias": {
            "value": "[parameters('sslUploadedPrivateKeyAlias')]"
          },
          "wlsPrivateKeyPassPhrase": {
            "value": "[parameters('sslUploadedPrivateKeyPassPhrase')]"
          },
          "wlsTrustKeyStoreData": {
            "value": "[parameters('sslUploadedCustomTrustKeyStoreData')]"
          },
          "wlsTrustKeyStorePassPhrase": {
            "value": "[parameters('sslUploadedCustomTrustKeyStorePassPhrase')]"
          },
          "wlsTrustKeyStoreType": {
            "value": "[variables('const_defaultKeystoreType')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "18390429331115339524"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": "pid-wls-end"
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": "pid-wls-start"
            },
            "aciResourcePermissions": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to use resource or workspace permissions. false to require workspace permissions."
              }
            },
            "aciRetentionInDays": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "Number of days to retain data in Azure Monitor workspace."
              }
            },
            "aciWorkspaceSku": {
              "type": "string",
              "defaultValue": "pergb2018",
              "metadata": {
                "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
              }
            },
            "acrName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksAgentPoolName": {
              "type": "string",
              "defaultValue": "agentpool",
              "metadata": {
                "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
              },
              "minLength": 1,
              "maxLength": 12
            },
            "aksAgentPoolNodeCount": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
              },
              "minValue": 1,
              "maxValue": 10000
            },
            "aksAgentPoolVMSize": {
              "type": "string",
              "defaultValue": "Standard_DS2_v2",
              "metadata": {
                "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
              }
            },
            "aksClusterNamePrefix": {
              "type": "string",
              "defaultValue": "wlsonaks",
              "metadata": {
                "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "The AKS version."
              }
            },
            "appPackageUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Urls of Java EE application packages."
              }
            },
            "appReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "The number of managed server to start."
              }
            },
            "createAKSCluster": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to create a new AKS cluster."
              }
            },
            "createStorageAccount": {
              "type": "bool",
              "defaultValue": false
            },
            "dbDriverLibrariesUrls": {
              "type": "array",
              "defaultValue": []
            },
            "enableAzureMonitoring": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to create persistent volume using file share."
              }
            },
            "enableAdminT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enableClusterT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePV": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object",
              "metadata": {
                "description": "An user assigned managed identity. Make sure the identity has permission to create/update/delete/list Azure resources."
              }
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "managedServerPrefix": {
              "type": "string",
              "defaultValue": "managed-server",
              "metadata": {
                "description": "Name prefix of managed server."
              }
            },
            "ocrSSOPSW": {
              "type": "secureString",
              "metadata": {
                "description": "Password of Oracle SSO account."
              }
            },
            "ocrSSOUser": {
              "type": "string",
              "metadata": {
                "description": "User name of Oracle SSO account."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "stg-contoso"
            },
            "t3ChannelAdminPort": {
              "type": "int",
              "defaultValue": 7005
            },
            "t3ChannelClusterPort": {
              "type": "int",
              "defaultValue": 8011
            },
            "userProvidedAcr": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedImagePath": {
              "type": "string",
              "defaultValue": "null"
            },
            "useOracleImage": {
              "type": "bool",
              "defaultValue": true
            },
            "wdtRuntimePassword": {
              "type": "secureString",
              "metadata": {
                "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
              }
            },
            "wlsClusterSize": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Maximum cluster size."
              }
            },
            "wlsCPU": {
              "type": "string",
              "defaultValue": "200m",
              "metadata": {
                "description": "Requests for CPU resources for admin server and managed server."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsImageTag": {
              "type": "string",
              "defaultValue": "12.2.1.4",
              "metadata": {
                "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
              }
            },
            "wlsJavaOption": {
              "type": "string",
              "defaultValue": "null"
            },
            "wlsMemory": {
              "type": "string",
              "defaultValue": "1.5Gi",
              "metadata": {
                "description": "Memory requests for admin server and managed server."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('createAKSCluster')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "aks-cluster-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aciResourcePermissions": {
                    "value": "[parameters('aciResourcePermissions')]"
                  },
                  "aciRetentionInDays": {
                    "value": "[parameters('aciRetentionInDays')]"
                  },
                  "aciWorkspaceSku": {
                    "value": "[parameters('aciWorkspaceSku')]"
                  },
                  "aksAgentPoolName": {
                    "value": "[parameters('aksAgentPoolName')]"
                  },
                  "aksAgentPoolNodeCount": {
                    "value": "[parameters('aksAgentPoolNodeCount')]"
                  },
                  "aksAgentPoolVMSize": {
                    "value": "[parameters('aksAgentPoolVMSize')]"
                  },
                  "aksClusterNamePrefix": {
                    "value": "[parameters('aksClusterNamePrefix')]"
                  },
                  "aksVersion": {
                    "value": "[parameters('aksVersion')]"
                  },
                  "enableAzureMonitoring": {
                    "value": "[parameters('enableAzureMonitoring')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "10199741218407780792"
                    }
                  },
                  "parameters": {
                    "aciResourcePermissions": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "true to use resource or workspace permissions. false to require workspace permissions."
                      }
                    },
                    "aciRetentionInDays": {
                      "type": "int",
                      "defaultValue": 120,
                      "metadata": {
                        "description": "Number of days to retain data in Azure Monitor workspace."
                      }
                    },
                    "aciWorkspaceSku": {
                      "type": "string",
                      "defaultValue": "pergb2018",
                      "metadata": {
                        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
                      }
                    },
                    "aksAgentPoolName": {
                      "type": "string",
                      "defaultValue": "agentpool",
                      "metadata": {
                        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
                      },
                      "minLength": 1,
                      "maxLength": 12
                    },
                    "aksAgentPoolNodeCount": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
                      },
                      "minValue": 1,
                      "maxValue": 10000
                    },
                    "aksAgentPoolVMSize": {
                      "type": "string",
                      "defaultValue": "Standard_DS2_v2",
                      "metadata": {
                        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
                      }
                    },
                    "aksClusterNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsonaks",
                      "metadata": {
                        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
                      }
                    },
                    "aksVersion": {
                      "type": "string",
                      "defaultValue": "default"
                    },
                    "enableAzureMonitoring": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_aksAgentPoolOSDiskSizeGB": 128,
                    "const_aksAgentPoolMaxPods": 110,
                    "const_aksAvailabilityZones": [
                      "1",
                      "2",
                      "3"
                    ],
                    "name_aciWorkspace": "[format('Workspace-{0}-{1}', guid(parameters('utcValue')), parameters('location'))]",
                    "name_aksClusterNameDefault": "[format('{0}0{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "name_aksClusterNameForSV": "[format('{0}1{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "obj_aciDisableOmsAgent": {
                      "enabled": false
                    },
                    "obj_aciEnableOmsAgent": {
                      "enabled": true,
                      "config": {
                        "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('enableAzureMonitoring')]",
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2020-08-01",
                      "name": "[variables('name_aciWorkspace')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "[parameters('aciWorkspaceSku')]"
                        },
                        "retentionInDays": "[parameters('aciRetentionInDays')]",
                        "features": {
                          "searchVersion": 1,
                          "legacy": 0,
                          "enableLogAccessUsingOnlyResourcePermissions": "[parameters('aciResourcePermissions')]"
                        }
                      }
                    },
                    {
                      "condition": "[contains(parameters('aksVersion'), 'default')]",
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('name_aksClusterNameDefault')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameDefault'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "kubenet",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    },
                    {
                      "condition": "[not(contains(parameters('aksVersion'), 'default'))]",
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('name_aksClusterNameForSV')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "kubernetesVersion": "[parameters('aksVersion')]",
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameForSV'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "kubenet",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "aksClusterName": {
                      "type": "string",
                      "value": "[if(equals(parameters('aksVersion'), 'default'), variables('name_aksClusterNameDefault'), variables('name_aksClusterNameForSV'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "condition": "[parameters('createStorageAccount')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "storage-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "1250147291009083074"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "stg-contoso"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_shareQuota": 5120,
                    "const_sku": "Standard_LRS",
                    "name_fileShare": "weblogic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[variables('const_sku')]",
                        "tier": "Standard"
                      },
                      "properties": {
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Allow"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "accessTier": "Hot"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/default/{1}', parameters('storageAccountName'), variables('name_fileShare'))]",
                      "properties": {
                        "accessTier": "TransactionOptimized",
                        "shareQuota": "[variables('const_shareQuota')]",
                        "enabledProtocols": "SMB"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-domain-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterRGName": {
                    "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
                  },
                  "aksClusterName": {
                    "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2019-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
                  },
                  "acrName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrName'), parameters('userProvidedAcr'))]"
                  },
                  "appPackageUrls": {
                    "value": "[parameters('appPackageUrls')]"
                  },
                  "appReplicas": {
                    "value": "[parameters('appReplicas')]"
                  },
                  "dbDriverLibrariesUrls": {
                    "value": "[parameters('dbDriverLibrariesUrls')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableAdminT3Tunneling": {
                    "value": "[parameters('enableAdminT3Tunneling')]"
                  },
                  "enableClusterT3Tunneling": {
                    "value": "[parameters('enableClusterT3Tunneling')]"
                  },
                  "enablePV": {
                    "value": "[parameters('enablePV')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "isSSOSupportEntitled": {
                    "value": "[parameters('isSSOSupportEntitled')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "managedServerPrefix": {
                    "value": "[parameters('managedServerPrefix')]"
                  },
                  "ocrSSOUser": {
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  "ocrSSOPSW": {
                    "value": "[parameters('ocrSSOPSW')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "t3ChannelAdminPort": {
                    "value": "[parameters('t3ChannelAdminPort')]"
                  },
                  "t3ChannelClusterPort": {
                    "value": "[parameters('t3ChannelClusterPort')]"
                  },
                  "userProvidedImagePath": {
                    "value": "[parameters('userProvidedImagePath')]"
                  },
                  "useOracleImage": {
                    "value": "[parameters('useOracleImage')]"
                  },
                  "wdtRuntimePassword": {
                    "value": "[parameters('wdtRuntimePassword')]"
                  },
                  "wlsClusterSize": {
                    "value": "[parameters('wlsClusterSize')]"
                  },
                  "wlsCPU": {
                    "value": "[parameters('wlsCPU')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsIdentityKeyStoreData": {
                    "value": "[parameters('wlsIdentityKeyStoreData')]"
                  },
                  "wlsIdentityKeyStorePassphrase": {
                    "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
                  },
                  "wlsIdentityKeyStoreType": {
                    "value": "[parameters('wlsIdentityKeyStoreType')]"
                  },
                  "wlsImageTag": {
                    "value": "[parameters('wlsImageTag')]"
                  },
                  "wlsJavaOption": {
                    "value": "[parameters('wlsJavaOption')]"
                  },
                  "wlsMemory": {
                    "value": "[parameters('wlsMemory')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsPrivateKeyAlias": {
                    "value": "[parameters('wlsPrivateKeyAlias')]"
                  },
                  "wlsPrivateKeyPassPhrase": {
                    "value": "[parameters('wlsPrivateKeyPassPhrase')]"
                  },
                  "wlsTrustKeyStoreData": {
                    "value": "[parameters('wlsTrustKeyStoreData')]"
                  },
                  "wlsTrustKeyStorePassPhrase": {
                    "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
                  },
                  "wlsTrustKeyStoreType": {
                    "value": "[parameters('wlsTrustKeyStoreType')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6770912978039849507"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appPackageUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "appReplicas": {
                      "type": "int",
                      "defaultValue": 2
                    },
                    "dbDriverLibrariesUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableAdminT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableClusterT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePV": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object"
                    },
                    "isSSOSupportEntitled": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "managedServerPrefix": {
                      "type": "string",
                      "defaultValue": "managed-server"
                    },
                    "ocrSSOPSW": {
                      "type": "secureString"
                    },
                    "ocrSSOUser": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "t3ChannelAdminPort": {
                      "type": "int",
                      "defaultValue": 7005
                    },
                    "t3ChannelClusterPort": {
                      "type": "int",
                      "defaultValue": 8011
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "userProvidedImagePath": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "useOracleImage": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "wdtRuntimePassword": {
                      "type": "secureString"
                    },
                    "wlsClusterSize": {
                      "type": "int",
                      "defaultValue": 5
                    },
                    "wlsCPU": {
                      "type": "string",
                      "defaultValue": "200m"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsIdentityKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStorePassphrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsImageTag": {
                      "type": "string",
                      "defaultValue": "12.2.1.4"
                    },
                    "wlsJavaOption": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "wlsMemory": {
                      "type": "string",
                      "defaultValue": "1.5Gi"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsPrivateKeyAlias": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsPrivateKeyPassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStorePassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_arguments": "[format('{0} {1} {2} {3} {4} {5} {6} {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} {18} {19} {20} {21} {22} {23} {24} {25} {26} {27} {28} {29} {30} {31} {32} {33} \"{34}\" {35} {36}', parameters('ocrSSOUser'), parameters('ocrSSOPSW'), parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('wlsImageTag'), parameters('acrName'), parameters('wlsDomainName'), parameters('wlsDomainUID'), parameters('wlsUserName'), parameters('wlsPassword'), parameters('wdtRuntimePassword'), parameters('wlsCPU'), parameters('wlsMemory'), parameters('managedServerPrefix'), parameters('appReplicas'), string(parameters('appPackageUrls')), resourceGroup().name, variables('const_scriptLocation'), parameters('storageAccountName'), parameters('wlsClusterSize'), parameters('enableCustomSSL'), parameters('wlsIdentityKeyStoreData'), parameters('wlsIdentityKeyStorePassphrase'), parameters('wlsIdentityKeyStoreType'), parameters('wlsPrivateKeyAlias'), parameters('wlsPrivateKeyPassPhrase'), parameters('wlsTrustKeyStoreData'), parameters('wlsTrustKeyStorePassPhrase'), parameters('wlsTrustKeyStoreType'), parameters('enablePV'), parameters('enableAdminT3Tunneling'), parameters('enableClusterT3Tunneling'), parameters('t3ChannelAdminPort'), parameters('t3ChannelClusterPort'), parameters('wlsJavaOption'), parameters('userProvidedImagePath'), parameters('useOracleImage'))]",
                    "const_buildDockerImageScript": "createVMAndBuildImage.sh",
                    "const_commonScript": "common.sh",
                    "const_invokeSetUpDomainScript": "invokeSetupWLSDomain.sh",
                    "const_pvTempalte": "pv.yaml.template",
                    "const_pvcTempalte": "pvc.yaml.template",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_genDomainConfigScript": "genDomainConfig.sh",
                    "const_setUpDomainScript": "setupWLSDomain.sh",
                    "const_updateDomainConfigScript": "updateDomainConfig.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-wls-cluster-creation",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "2.15.0",
                        "arguments": "[variables('const_arguments')]",
                        "environmentVariables": [
                          {
                            "name": "URL_3RD_DATASOURCE",
                            "value": "[string(parameters('dbDriverLibrariesUrls'))]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_ENTITLED",
                            "value": "[string(parameters('isSSOSupportEntitled'))]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_invokeSetUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_genDomainConfigScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvcTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_buildDockerImageScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_updateDomainConfigScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            }
          ],
          "outputs": {
            "aksClusterName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2019-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
            },
            "aksClusterRGName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
            },
            "adminServerEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-admin-server.{0}-ns.svc.cluster.local:7001/console', parameters('wlsDomainUID'))]"
            },
            "adminServerT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableAdminT3Tunneling'), format('{0}://{1}-admin-server.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelAdminPort')), '')]"
            },
            "clusterEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-cluster-cluster-1.{0}-ns.svc.cluster.local:8001/', parameters('wlsDomainUID'))]"
            },
            "clusterT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableClusterT3Tunneling'), format('{0}://{1}-cluster-cluster-1.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelClusterPort')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account')]",
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]"
      ]
    },
    {
      "condition": "[parameters('enableCustomSSL')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "setup-wls-cluster-with-custom-ssl-enabled",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSEnd.value)]"
          },
          "_pidStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.wlsAKSStart.value)]"
          },
          "aciResourcePermissions": {
            "value": "[parameters('aciResourcePermissions')]"
          },
          "aciRetentionInDays": {
            "value": "[parameters('aciRetentionInDays')]"
          },
          "aciWorkspaceSku": {
            "value": "[parameters('aciWorkspaceSku')]"
          },
          "acrName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment'), '2019-10-01').outputs.acrName.value]"
          },
          "aksAgentPoolName": {
            "value": "[parameters('aksAgentPoolName')]"
          },
          "aksAgentPoolNodeCount": {
            "value": "[parameters('aksAgentPoolNodeCount')]"
          },
          "aksAgentPoolVMSize": {
            "value": "[parameters('aksAgentPoolVMSize')]"
          },
          "aksClusterNamePrefix": {
            "value": "[parameters('aksClusterNamePrefix')]"
          },
          "aksClusterRGName": {
            "value": "[parameters('aksClusterRGName')]"
          },
          "aksClusterName": {
            "value": "[parameters('aksClusterName')]"
          },
          "aksVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast'), '2019-10-01').outputs.aksVersion.value]"
          },
          "appPackageUrls": {
            "value": "[parameters('appPackageUrls')]"
          },
          "appReplicas": {
            "value": "[parameters('appReplicas')]"
          },
          "createAKSCluster": {
            "value": "[parameters('createAKSCluster')]"
          },
          "createStorageAccount": {
            "value": "[and(or(parameters('createAKSCluster'), not(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))))), variables('const_enablePV'))]"
          },
          "dbDriverLibrariesUrls": {
            "value": "[parameters('dbDriverLibrariesUrls')]"
          },
          "enableAzureMonitoring": {
            "value": "[parameters('enableAzureMonitoring')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableAdminT3Tunneling": {
            "value": "[parameters('enableAdminT3Tunneling')]"
          },
          "enableClusterT3Tunneling": {
            "value": "[parameters('enableClusterT3Tunneling')]"
          },
          "enablePV": {
            "value": "[variables('const_enablePV')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "isSSOSupportEntitled": {
            "value": "[parameters('isSSOSupportEntitled')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "managedServerPrefix": {
            "value": "[parameters('managedServerPrefix')]"
          },
          "ocrSSOPSW": {
            "value": "[parameters('ocrSSOPSW')]"
          },
          "ocrSSOUser": {
            "value": "[parameters('ocrSSOUser')]"
          },
          "storageAccountName": {
            "value": "[if(and(not(parameters('createAKSCluster')), not(equals(reference('query-existing-storage-account').outputs.storageAccount.value, 'null'))), reference('query-existing-storage-account').outputs.storageAccount.value, format('wls{0}', uniqueString(parameters('utcValue'))))]"
          },
          "t3ChannelAdminPort": {
            "value": "[parameters('t3ChannelAdminPort')]"
          },
          "t3ChannelClusterPort": {
            "value": "[parameters('t3ChannelClusterPort')]"
          },
          "userProvidedAcr": {
            "value": "[parameters('userProvidedAcr')]"
          },
          "userProvidedImagePath": {
            "value": "[parameters('userProvidedImagePath')]"
          },
          "useOracleImage": {
            "value": "[parameters('useOracleImage')]"
          },
          "wdtRuntimePassword": {
            "value": "[parameters('wdtRuntimePassword')]"
          },
          "wlsClusterSize": {
            "value": "[parameters('wlsClusterSize')]"
          },
          "wlsCPU": {
            "value": "[parameters('wlsCPU')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsIdentityKeyStoreData": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_identityKeyStoreDataSecret')]"
            }
          },
          "wlsIdentityKeyStorePassphrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_identityKeyStorePswSecret')]"
            }
          },
          "wlsIdentityKeyStoreType": {
            "value": "[variables('const_identityKeyStoreType')]"
          },
          "wlsImageTag": {
            "value": "[parameters('wlsImageTag')]"
          },
          "wlsJavaOption": {
            "value": "[variables('const_wlsJavaOptions')]"
          },
          "wlsMemory": {
            "value": "[parameters('wlsMemory')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsPrivateKeyAlias": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_privateKeyAliasSecret')]"
            }
          },
          "wlsPrivateKeyPassPhrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_privateKeyPswSecret')]"
            }
          },
          "wlsTrustKeyStoreData": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_trustKeyStoreDataSecret')]"
            }
          },
          "wlsTrustKeyStorePassPhrase": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('name_rgKeyvaultForWLSSSL')), 'Microsoft.KeyVault/vaults', if(equals(parameters('sslConfigurationAccessOption'), variables('const_wlsSSLCertOptionKeyVault')), parameters('sslKeyVaultName'), variables('name_keyVaultName')))]"
              },
              "secretName": "[variables('name_trustKeyStorePswSecret')]"
            }
          },
          "wlsTrustKeyStoreType": {
            "value": "[variables('const_trustKeyStoreType')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "18390429331115339524"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": "pid-wls-end"
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": "pid-wls-start"
            },
            "aciResourcePermissions": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to use resource or workspace permissions. false to require workspace permissions."
              }
            },
            "aciRetentionInDays": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "Number of days to retain data in Azure Monitor workspace."
              }
            },
            "aciWorkspaceSku": {
              "type": "string",
              "defaultValue": "pergb2018",
              "metadata": {
                "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
              }
            },
            "acrName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksAgentPoolName": {
              "type": "string",
              "defaultValue": "agentpool",
              "metadata": {
                "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
              },
              "minLength": 1,
              "maxLength": 12
            },
            "aksAgentPoolNodeCount": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
              },
              "minValue": 1,
              "maxValue": 10000
            },
            "aksAgentPoolVMSize": {
              "type": "string",
              "defaultValue": "Standard_DS2_v2",
              "metadata": {
                "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
              }
            },
            "aksClusterNamePrefix": {
              "type": "string",
              "defaultValue": "wlsonaks",
              "metadata": {
                "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksVersion": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "The AKS version."
              }
            },
            "appPackageUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Urls of Java EE application packages."
              }
            },
            "appReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "The number of managed server to start."
              }
            },
            "createAKSCluster": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "true to create a new AKS cluster."
              }
            },
            "createStorageAccount": {
              "type": "bool",
              "defaultValue": false
            },
            "dbDriverLibrariesUrls": {
              "type": "array",
              "defaultValue": []
            },
            "enableAzureMonitoring": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to create persistent volume using file share."
              }
            },
            "enableAdminT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enableClusterT3Tunneling": {
              "type": "bool",
              "defaultValue": false
            },
            "enablePV": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object",
              "metadata": {
                "description": "An user assigned managed identity. Make sure the identity has permission to create/update/delete/list Azure resources."
              }
            },
            "isSSOSupportEntitled": {
              "type": "bool"
            },
            "location": {
              "type": "string"
            },
            "managedServerPrefix": {
              "type": "string",
              "defaultValue": "managed-server",
              "metadata": {
                "description": "Name prefix of managed server."
              }
            },
            "ocrSSOPSW": {
              "type": "secureString",
              "metadata": {
                "description": "Password of Oracle SSO account."
              }
            },
            "ocrSSOUser": {
              "type": "string",
              "metadata": {
                "description": "User name of Oracle SSO account."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "stg-contoso"
            },
            "t3ChannelAdminPort": {
              "type": "int",
              "defaultValue": 7005
            },
            "t3ChannelClusterPort": {
              "type": "int",
              "defaultValue": 8011
            },
            "userProvidedAcr": {
              "type": "string",
              "defaultValue": "null"
            },
            "userProvidedImagePath": {
              "type": "string",
              "defaultValue": "null"
            },
            "useOracleImage": {
              "type": "bool",
              "defaultValue": true
            },
            "wdtRuntimePassword": {
              "type": "secureString",
              "metadata": {
                "description": "Password for model WebLogic Deploy Tooling runtime encrytion."
              }
            },
            "wlsClusterSize": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Maximum cluster size."
              }
            },
            "wlsCPU": {
              "type": "string",
              "defaultValue": "200m",
              "metadata": {
                "description": "Requests for CPU resources for admin server and managed server."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsIdentityKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStorePassphrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsIdentityKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsImageTag": {
              "type": "string",
              "defaultValue": "12.2.1.4",
              "metadata": {
                "description": "Docker tag that comes after \"container-registry.oracle.com/middleware/weblogic:\""
              }
            },
            "wlsJavaOption": {
              "type": "string",
              "defaultValue": "null"
            },
            "wlsMemory": {
              "type": "string",
              "defaultValue": "1.5Gi",
              "metadata": {
                "description": "Memory requests for admin server and managed server."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsPrivateKeyAlias": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsPrivateKeyPassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreData": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStorePassPhrase": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "wlsTrustKeyStoreType": {
              "type": "string",
              "defaultValue": "PKCS12",
              "allowedValues": [
                "JKS",
                "PKCS12"
              ]
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('createAKSCluster')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "aks-cluster-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aciResourcePermissions": {
                    "value": "[parameters('aciResourcePermissions')]"
                  },
                  "aciRetentionInDays": {
                    "value": "[parameters('aciRetentionInDays')]"
                  },
                  "aciWorkspaceSku": {
                    "value": "[parameters('aciWorkspaceSku')]"
                  },
                  "aksAgentPoolName": {
                    "value": "[parameters('aksAgentPoolName')]"
                  },
                  "aksAgentPoolNodeCount": {
                    "value": "[parameters('aksAgentPoolNodeCount')]"
                  },
                  "aksAgentPoolVMSize": {
                    "value": "[parameters('aksAgentPoolVMSize')]"
                  },
                  "aksClusterNamePrefix": {
                    "value": "[parameters('aksClusterNamePrefix')]"
                  },
                  "aksVersion": {
                    "value": "[parameters('aksVersion')]"
                  },
                  "enableAzureMonitoring": {
                    "value": "[parameters('enableAzureMonitoring')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "10199741218407780792"
                    }
                  },
                  "parameters": {
                    "aciResourcePermissions": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "true to use resource or workspace permissions. false to require workspace permissions."
                      }
                    },
                    "aciRetentionInDays": {
                      "type": "int",
                      "defaultValue": 120,
                      "metadata": {
                        "description": "Number of days to retain data in Azure Monitor workspace."
                      }
                    },
                    "aciWorkspaceSku": {
                      "type": "string",
                      "defaultValue": "pergb2018",
                      "metadata": {
                        "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
                      }
                    },
                    "aksAgentPoolName": {
                      "type": "string",
                      "defaultValue": "agentpool",
                      "metadata": {
                        "description": "The name for this node pool. Node pool must contain only lowercase letters and numbers. For Linux node pools the name cannot be longer than 12 characters."
                      },
                      "minLength": 1,
                      "maxLength": 12
                    },
                    "aksAgentPoolNodeCount": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "The number of nodes that should be created along with the cluster. You will be able to resize the cluster later."
                      },
                      "minValue": 1,
                      "maxValue": 10000
                    },
                    "aksAgentPoolVMSize": {
                      "type": "string",
                      "defaultValue": "Standard_DS2_v2",
                      "metadata": {
                        "description": "The size of the virtual machines that will form the nodes in the cluster. This cannot be changed after creating the cluster"
                      }
                    },
                    "aksClusterNamePrefix": {
                      "type": "string",
                      "defaultValue": "wlsonaks",
                      "metadata": {
                        "description": "Prefix for cluster name. Only The name can contain only letters, numbers, underscores and hyphens. The name must start with letter or number."
                      }
                    },
                    "aksVersion": {
                      "type": "string",
                      "defaultValue": "default"
                    },
                    "enableAzureMonitoring": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "In addition to the CPU and memory metrics included in AKS by default, you can enable Container Insights for more comprehensive data on the overall performance and health of your cluster. Billing is based on data ingestion and retention settings."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_aksAgentPoolOSDiskSizeGB": 128,
                    "const_aksAgentPoolMaxPods": 110,
                    "const_aksAvailabilityZones": [
                      "1",
                      "2",
                      "3"
                    ],
                    "name_aciWorkspace": "[format('Workspace-{0}-{1}', guid(parameters('utcValue')), parameters('location'))]",
                    "name_aksClusterNameDefault": "[format('{0}0{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "name_aksClusterNameForSV": "[format('{0}1{1}', parameters('aksClusterNamePrefix'), uniqueString(parameters('utcValue')))]",
                    "obj_aciDisableOmsAgent": {
                      "enabled": false
                    },
                    "obj_aciEnableOmsAgent": {
                      "enabled": true,
                      "config": {
                        "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('enableAzureMonitoring')]",
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2020-08-01",
                      "name": "[variables('name_aciWorkspace')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "name": "[parameters('aciWorkspaceSku')]"
                        },
                        "retentionInDays": "[parameters('aciRetentionInDays')]",
                        "features": {
                          "searchVersion": 1,
                          "legacy": 0,
                          "enableLogAccessUsingOnlyResourcePermissions": "[parameters('aciResourcePermissions')]"
                        }
                      }
                    },
                    {
                      "condition": "[contains(parameters('aksVersion'), 'default')]",
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('name_aksClusterNameDefault')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameDefault'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "kubenet",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    },
                    {
                      "condition": "[not(contains(parameters('aksVersion'), 'default'))]",
                      "type": "Microsoft.ContainerService/managedClusters",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('name_aksClusterNameForSV')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "kubernetesVersion": "[parameters('aksVersion')]",
                        "dnsPrefix": "[format('{0}-dns', variables('name_aksClusterNameForSV'))]",
                        "agentPoolProfiles": [
                          {
                            "name": "[parameters('aksAgentPoolName')]",
                            "count": "[parameters('aksAgentPoolNodeCount')]",
                            "vmSize": "[parameters('aksAgentPoolVMSize')]",
                            "osDiskSizeGB": "[variables('const_aksAgentPoolOSDiskSizeGB')]",
                            "osDiskType": "Managed",
                            "kubeletDiskType": "OS",
                            "maxPods": "[variables('const_aksAgentPoolMaxPods')]",
                            "type": "VirtualMachineScaleSets",
                            "availabilityZones": "[variables('const_aksAvailabilityZones')]",
                            "mode": "System",
                            "osType": "Linux"
                          }
                        ],
                        "addonProfiles": {
                          "KubeDashboard": {
                            "enabled": false
                          },
                          "azurepolicy": {
                            "enabled": false
                          },
                          "httpApplicationRouting": {
                            "enabled": false
                          },
                          "omsAgent": "[if(parameters('enableAzureMonitoring'), variables('obj_aciEnableOmsAgent'), variables('obj_aciDisableOmsAgent'))]"
                        },
                        "enableRBAC": true,
                        "networkProfile": {
                          "networkPlugin": "kubenet",
                          "loadBalancerSku": "standard"
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('name_aciWorkspace'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "aksClusterName": {
                      "type": "string",
                      "value": "[if(equals(parameters('aksVersion'), 'default'), variables('name_aksClusterNameDefault'), variables('name_aksClusterNameForSV'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "condition": "[parameters('createStorageAccount')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "storage-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "1250147291009083074"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "stg-contoso"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_shareQuota": 5120,
                    "const_sku": "Standard_LRS",
                    "name_fileShare": "weblogic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[variables('const_sku')]",
                        "tier": "Standard"
                      },
                      "properties": {
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Allow"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "accessTier": "Hot"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/default/{1}', parameters('storageAccountName'), variables('name_fileShare'))]",
                      "properties": {
                        "accessTier": "TransactionOptimized",
                        "shareQuota": "[variables('const_shareQuota')]",
                        "enabledProtocols": "SMB"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-domain-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterRGName": {
                    "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
                  },
                  "aksClusterName": {
                    "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2019-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
                  },
                  "acrName": {
                    "value": "[if(parameters('useOracleImage'), parameters('acrName'), parameters('userProvidedAcr'))]"
                  },
                  "appPackageUrls": {
                    "value": "[parameters('appPackageUrls')]"
                  },
                  "appReplicas": {
                    "value": "[parameters('appReplicas')]"
                  },
                  "dbDriverLibrariesUrls": {
                    "value": "[parameters('dbDriverLibrariesUrls')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableAdminT3Tunneling": {
                    "value": "[parameters('enableAdminT3Tunneling')]"
                  },
                  "enableClusterT3Tunneling": {
                    "value": "[parameters('enableClusterT3Tunneling')]"
                  },
                  "enablePV": {
                    "value": "[parameters('enablePV')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "isSSOSupportEntitled": {
                    "value": "[parameters('isSSOSupportEntitled')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "managedServerPrefix": {
                    "value": "[parameters('managedServerPrefix')]"
                  },
                  "ocrSSOUser": {
                    "value": "[parameters('ocrSSOUser')]"
                  },
                  "ocrSSOPSW": {
                    "value": "[parameters('ocrSSOPSW')]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "t3ChannelAdminPort": {
                    "value": "[parameters('t3ChannelAdminPort')]"
                  },
                  "t3ChannelClusterPort": {
                    "value": "[parameters('t3ChannelClusterPort')]"
                  },
                  "userProvidedImagePath": {
                    "value": "[parameters('userProvidedImagePath')]"
                  },
                  "useOracleImage": {
                    "value": "[parameters('useOracleImage')]"
                  },
                  "wdtRuntimePassword": {
                    "value": "[parameters('wdtRuntimePassword')]"
                  },
                  "wlsClusterSize": {
                    "value": "[parameters('wlsClusterSize')]"
                  },
                  "wlsCPU": {
                    "value": "[parameters('wlsCPU')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsIdentityKeyStoreData": {
                    "value": "[parameters('wlsIdentityKeyStoreData')]"
                  },
                  "wlsIdentityKeyStorePassphrase": {
                    "value": "[parameters('wlsIdentityKeyStorePassphrase')]"
                  },
                  "wlsIdentityKeyStoreType": {
                    "value": "[parameters('wlsIdentityKeyStoreType')]"
                  },
                  "wlsImageTag": {
                    "value": "[parameters('wlsImageTag')]"
                  },
                  "wlsJavaOption": {
                    "value": "[parameters('wlsJavaOption')]"
                  },
                  "wlsMemory": {
                    "value": "[parameters('wlsMemory')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsPrivateKeyAlias": {
                    "value": "[parameters('wlsPrivateKeyAlias')]"
                  },
                  "wlsPrivateKeyPassPhrase": {
                    "value": "[parameters('wlsPrivateKeyPassPhrase')]"
                  },
                  "wlsTrustKeyStoreData": {
                    "value": "[parameters('wlsTrustKeyStoreData')]"
                  },
                  "wlsTrustKeyStorePassPhrase": {
                    "value": "[parameters('wlsTrustKeyStorePassPhrase')]"
                  },
                  "wlsTrustKeyStoreType": {
                    "value": "[parameters('wlsTrustKeyStoreType')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "6770912978039849507"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "acrName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appPackageUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "appReplicas": {
                      "type": "int",
                      "defaultValue": 2
                    },
                    "dbDriverLibrariesUrls": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableAdminT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableClusterT3Tunneling": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enablePV": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object"
                    },
                    "isSSOSupportEntitled": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "managedServerPrefix": {
                      "type": "string",
                      "defaultValue": "managed-server"
                    },
                    "ocrSSOPSW": {
                      "type": "secureString"
                    },
                    "ocrSSOUser": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "t3ChannelAdminPort": {
                      "type": "int",
                      "defaultValue": 7005
                    },
                    "t3ChannelClusterPort": {
                      "type": "int",
                      "defaultValue": 8011
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "userProvidedImagePath": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "useOracleImage": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "wdtRuntimePassword": {
                      "type": "secureString"
                    },
                    "wlsClusterSize": {
                      "type": "int",
                      "defaultValue": 5
                    },
                    "wlsCPU": {
                      "type": "string",
                      "defaultValue": "200m"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsIdentityKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStorePassphrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsIdentityKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsImageTag": {
                      "type": "string",
                      "defaultValue": "12.2.1.4"
                    },
                    "wlsJavaOption": {
                      "type": "string",
                      "defaultValue": "null"
                    },
                    "wlsMemory": {
                      "type": "string",
                      "defaultValue": "1.5Gi"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsPrivateKeyAlias": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsPrivateKeyPassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStorePassPhrase": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "wlsTrustKeyStoreType": {
                      "type": "string",
                      "defaultValue": "PKCS12",
                      "allowedValues": [
                        "JKS",
                        "PKCS12"
                      ]
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_arguments": "[format('{0} {1} {2} {3} {4} {5} {6} {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} {18} {19} {20} {21} {22} {23} {24} {25} {26} {27} {28} {29} {30} {31} {32} {33} \"{34}\" {35} {36}', parameters('ocrSSOUser'), parameters('ocrSSOPSW'), parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('wlsImageTag'), parameters('acrName'), parameters('wlsDomainName'), parameters('wlsDomainUID'), parameters('wlsUserName'), parameters('wlsPassword'), parameters('wdtRuntimePassword'), parameters('wlsCPU'), parameters('wlsMemory'), parameters('managedServerPrefix'), parameters('appReplicas'), string(parameters('appPackageUrls')), resourceGroup().name, variables('const_scriptLocation'), parameters('storageAccountName'), parameters('wlsClusterSize'), parameters('enableCustomSSL'), parameters('wlsIdentityKeyStoreData'), parameters('wlsIdentityKeyStorePassphrase'), parameters('wlsIdentityKeyStoreType'), parameters('wlsPrivateKeyAlias'), parameters('wlsPrivateKeyPassPhrase'), parameters('wlsTrustKeyStoreData'), parameters('wlsTrustKeyStorePassPhrase'), parameters('wlsTrustKeyStoreType'), parameters('enablePV'), parameters('enableAdminT3Tunneling'), parameters('enableClusterT3Tunneling'), parameters('t3ChannelAdminPort'), parameters('t3ChannelClusterPort'), parameters('wlsJavaOption'), parameters('userProvidedImagePath'), parameters('useOracleImage'))]",
                    "const_buildDockerImageScript": "createVMAndBuildImage.sh",
                    "const_commonScript": "common.sh",
                    "const_invokeSetUpDomainScript": "invokeSetupWLSDomain.sh",
                    "const_pvTempalte": "pv.yaml.template",
                    "const_pvcTempalte": "pvc.yaml.template",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_genDomainConfigScript": "genDomainConfig.sh",
                    "const_setUpDomainScript": "setupWLSDomain.sh",
                    "const_updateDomainConfigScript": "updateDomainConfig.sh",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-wls-cluster-creation",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "2.15.0",
                        "arguments": "[variables('const_arguments')]",
                        "environmentVariables": [
                          {
                            "name": "URL_3RD_DATASOURCE",
                            "value": "[string(parameters('dbDriverLibrariesUrls'))]"
                          },
                          {
                            "name": "ORACLE_ACCOUNT_ENTITLED",
                            "value": "[string(parameters('isSSOSupportEntitled'))]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_invokeSetUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setUpDomainScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_genDomainConfigScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pvcTempalte'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_buildDockerImageScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_updateDomainConfigScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'storage-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-domain-deployment')]"
              ]
            }
          ],
          "outputs": {
            "aksClusterName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), reference(resourceId('Microsoft.Resources/deployments', 'aks-cluster-deployment'), '2019-10-01').outputs.aksClusterName.value, parameters('aksClusterName'))]"
            },
            "aksClusterRGName": {
              "type": "string",
              "value": "[if(parameters('createAKSCluster'), resourceGroup().name, parameters('aksClusterRGName'))]"
            },
            "adminServerEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-admin-server.{0}-ns.svc.cluster.local:7001/console', parameters('wlsDomainUID'))]"
            },
            "adminServerT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableAdminT3Tunneling'), format('{0}://{1}-admin-server.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelAdminPort')), '')]"
            },
            "clusterEndPoint": {
              "type": "string",
              "value": "[format('http://{0}-cluster-cluster-1.{0}-ns.svc.cluster.local:8001/', parameters('wlsDomainUID'))]"
            },
            "clusterT3InternalEndPoint": {
              "type": "string",
              "value": "[if(parameters('enableClusterT3Tunneling'), format('{0}://{1}-cluster-cluster-1.{1}-ns.svc.cluster.local:{2}', if(parameters('enableCustomSSL'), 't3s', 't3'), parameters('wlsDomainUID'), parameters('t3ChannelClusterPort')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'pre-azure-resources-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'query-existing-storage-account')]",
        "[resourceId('Microsoft.Resources/deployments', 'validate-parameters-and-fail-fast')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]",
        "[resourceId('Microsoft.Resources/deployments', 'upload-wls-ssl-cert-to-keyvault')]"
      ]
    },
    {
      "condition": "[and(parameters('enableAppGWIngress'), not(equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "appgateway-certificates-secrets-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "backendCertificateDataValue": {
            "value": "[parameters('appGatewaySSLBackendRootCertData')]"
          },
          "certificateDataValue": {
            "value": "[parameters('appGatewaySSLCertData')]"
          },
          "certificatePasswordValue": {
            "value": "[parameters('appGatewaySSLCertPassword')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('keyVaultSku')]"
          },
          "subjectName": {
            "value": "[format('CN={0}', if(parameters('enableDNSConfiguration'), format('{0}.{1}', parameters('dnsNameforApplicationGateway'), parameters('dnszoneName')), variables('const_azureSubjectName')))]"
          },
          "useExistingAppGatewaySSLCertificate": {
            "value": "[variables('_useExistingAppGatewaySSLCertificate')]"
          },
          "keyVaultName": {
            "value": "[variables('name_keyVaultName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "7422817768063728346"
            }
          },
          "parameters": {
            "backendCertificateDataValue": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Backend certificate data to store in the secret"
              }
            },
            "certificateDataValue": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Certificate data to store in the secret"
              }
            },
            "certificatePasswordValue": {
              "type": "secureString",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Certificate password to store in the secret"
              }
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to upload trusted root certificate"
              }
            },
            "enabledForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "identity": {
              "type": "object"
            },
            "location": {
              "type": "string"
            },
            "permission": {
              "type": "object",
              "defaultValue": {
                "certificates": [
                  "get",
                  "list",
                  "update",
                  "create"
                ]
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "Price tier for Key Vault."
              }
            },
            "subjectName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Subject name to create a certificate."
              }
            },
            "useExistingAppGatewaySSLCertificate": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "If false, will create a certificate."
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "GEN_UNIQUE",
              "metadata": {
                "description": "Current deployment time. Used as a tag in deployment script."
              }
            }
          },
          "functions": [],
          "variables": {
            "name_sslBackendCertSercretName": "myAppGatewaySSLBackendRootCert",
            "name_sslCertSecretName": "myAppGatewaySSLCert",
            "name_sslCertPasswordSecretName": "myAppGatewaySSLCertPassword"
          },
          "resources": [
            {
              "condition": "[not(parameters('useExistingAppGatewaySSLCertificate'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "kv-appgw-selfsigned-certificate-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "permission": {
                    "value": "[parameters('permission')]"
                  },
                  "subjectName": {
                    "value": "[parameters('subjectName')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "7615847068097210249"
                    }
                  },
                  "parameters": {
                    "identity": {
                      "type": "object",
                      "metadata": {
                        "description": "Managed identity to be used for the deployment script. Currently, only user-assigned MSI is supported."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "defaultValue": "[format('wls-kv-{0}', uniqueString(parameters('utcValue')))]",
                      "metadata": {
                        "description": "Used to name the new Azure Key Vault resoure."
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "permission": {
                      "type": "object",
                      "defaultValue": {
                        "certificates": [
                          "get",
                          "list",
                          "update",
                          "create"
                        ]
                      },
                      "metadata": {
                        "description": "Access permission of the key vault, will applied to all access policies."
                      }
                    },
                    "secretName": {
                      "type": "string",
                      "defaultValue": "mySelfSignedCertificate",
                      "metadata": {
                        "description": "Used to name the new certificate resource."
                      }
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "subjectName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz",
                      "metadata": {
                        "description": "Subject name to create a new certificate, example: 'CN=contoso.com'."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_identityId": "[substring(string(parameters('identity').userAssignedIdentities), add(indexOf(string(parameters('identity').userAssignedIdentities), '\"'), 1), sub(lastIndexOf(string(parameters('identity').userAssignedIdentities), '\"'), add(indexOf(string(parameters('identity').userAssignedIdentities), '\"'), 1)))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2021-10-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "family": "A",
                          "name": "[parameters('sku')]"
                        },
                        "tenantId": "[subscription().tenantId]",
                        "accessPolicies": [
                          {
                            "objectId": "[reference(variables('const_identityId'), '2018-11-30').principalId]",
                            "tenantId": "[subscription().tenantId]",
                            "permissions": "[parameters('permission')]"
                          }
                        ],
                        "enabledForDeployment": false,
                        "enabledForDiskEncryption": false,
                        "enabledForTemplateDeployment": true,
                        "enableSoftDelete": true
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-create-add-appgw-certificate",
                      "location": "[parameters('location')]",
                      "identity": "[parameters('identity')]",
                      "kind": "AzurePowerShell",
                      "properties": {
                        "forceUpdateTag": "[parameters('utcValue')]",
                        "azPowerShellVersion": "5.0",
                        "timeout": "PT30M",
                        "arguments": "[format(' -vaultName {0} -certificateName {1} -subjectName {2}', parameters('keyVaultName'), parameters('secretName'), parameters('subjectName'))]",
                        "scriptContent": "\n                    param(\n                        [string] [Parameter(Mandatory=$true)] $vaultName,\n                        [string] [Parameter(Mandatory=$true)] $certificateName,\n                        [string] [Parameter(Mandatory=$true)] $subjectName\n                    )\n\n                    $ErrorActionPreference = 'Stop'\n                    $DeploymentScriptOutputs = @{}\n\n                    $existingCert = Get-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName\n\n                    if ($existingCert -and $existingCert.Certificate.Subject -eq $subjectName) {\n\n                        Write-Host 'Certificate $certificateName in vault $vaultName is already present.'\n\n                        $DeploymentScriptOutputs['certThumbprint'] = $existingCert.Thumbprint\n                        $existingCert | Out-String\n                    }\n                    else {\n                        $policy = New-AzKeyVaultCertificatePolicy -SubjectName $subjectName -IssuerName Self -ValidityInMonths 12 -Verbose\n\n                        # private key is added as a secret that can be retrieved in the ARM template\n                        Add-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName -CertificatePolicy $policy -Verbose\n\n                        $newCert = Get-AzKeyVaultCertificate -VaultName $vaultName -Name $certificateName\n\n                        # it takes a few seconds for KeyVault to finish\n                        $tries = 0\n                        do {\n                        Write-Host 'Waiting for certificate creation completion...'\n                        Start-Sleep -Seconds 10\n                        $operation = Get-AzKeyVaultCertificateOperation -VaultName $vaultName -Name $certificateName\n                        $tries++\n\n                        if ($operation.Status -eq 'failed')\n                        {\n                            throw 'Creating certificate $certificateName in vault $vaultName failed with error $($operation.ErrorMessage)'\n                        }\n\n                        if ($tries -gt 120)\n                        {\n                            throw 'Timed out waiting for creation of certificate $certificateName in vault $vaultName'\n                        }\n                        } while ($operation.Status -ne 'completed')\n\n                        $DeploymentScriptOutputs['certThumbprint'] = $newCert.Thumbprint\n                        $newCert | Out-String\n                    }\n                ",
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "secretName": {
                      "type": "string",
                      "value": "[parameters('secretName')]"
                    },
                    "identityId": {
                      "type": "string",
                      "value": "[variables('const_identityId')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('useExistingAppGatewaySSLCertificate')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "kv-appgw-existing-certificate-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "certificateDataName": {
                    "value": "[variables('name_sslCertSecretName')]"
                  },
                  "certificateDataValue": {
                    "value": "[parameters('certificateDataValue')]"
                  },
                  "certificatePswSecretName": {
                    "value": "[variables('name_sslCertPasswordSecretName')]"
                  },
                  "certificatePasswordValue": {
                    "value": "[parameters('certificatePasswordValue')]"
                  },
                  "enabledForTemplateDeployment": {
                    "value": "[parameters('enabledForTemplateDeployment')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "15580247868160436600"
                    }
                  },
                  "parameters": {
                    "certificateDataName": {
                      "type": "string",
                      "defaultValue": "myIdentityKeyStoreData",
                      "metadata": {
                        "description": "Secret name of certificate data."
                      }
                    },
                    "certificateDataValue": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate data to store in the secret"
                      }
                    },
                    "certificatePswSecretName": {
                      "type": "string",
                      "defaultValue": "myIdentityKeyStorePsw",
                      "metadata": {
                        "description": "Secret name of certificate password."
                      }
                    },
                    "certificatePasswordValue": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate password to store in the secret"
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "defaultValue": "kv-contoso",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2021-10-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "accessPolicies": [],
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "sku": {
                          "name": "[parameters('sku')]",
                          "family": "A"
                        },
                        "tenantId": "[subscription().tenantId]"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-10-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificateDataName'))]",
                      "properties": {
                        "value": "[parameters('certificateDataValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-10-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificatePswSecretName'))]",
                      "properties": {
                        "value": "[parameters('certificatePasswordValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "sslCertDataSecretName": {
                      "type": "string",
                      "value": "[parameters('certificateDataName')]"
                    },
                    "sslCertPwdSecretName": {
                      "type": "string",
                      "value": "[parameters('certificatePswSecretName')]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableCustomSSL')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "kv-appgw-e2e-ssl-backend-certificate",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "certificateDataName": {
                    "value": "[variables('name_sslBackendCertSercretName')]"
                  },
                  "certificateDataValue": {
                    "value": "[parameters('backendCertificateDataValue')]"
                  },
                  "enabledForTemplateDeployment": {
                    "value": "[parameters('enabledForTemplateDeployment')]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "sku": {
                    "value": "[parameters('sku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "629816166833826732"
                    }
                  },
                  "parameters": {
                    "certificateDataName": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Secret name of certificate data."
                      }
                    },
                    "certificateDataValue": {
                      "type": "string",
                      "defaultValue": "[newGuid()]",
                      "metadata": {
                        "description": "Certificate data to store in the secret"
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "location": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "metadata": {
                        "description": "Price tier for Key Vault."
                      }
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2021-10-01",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "accessPolicies": [],
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "sku": {
                          "name": "[parameters('sku')]",
                          "family": "A"
                        },
                        "tenantId": "[subscription().tenantId]"
                      },
                      "tags": {
                        "managed-by-azure-weblogic": "[parameters('utcValue')]"
                      }
                    },
                    {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-10-01",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('certificateDataName'))]",
                      "properties": {
                        "value": "[parameters('certificateDataValue')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "keyVaultName": {
                      "type": "string",
                      "value": "[parameters('keyVaultName')]"
                    },
                    "sslBackendCertDataSecretName": {
                      "type": "string",
                      "value": "[parameters('certificateDataName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment')]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2019-10-01').outputs.keyVaultName.value, reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment'), '2019-10-01').outputs.keyVaultName.value)]"
            },
            "sslCertDataSecretName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2019-10-01').outputs.sslCertDataSecretName.value, reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-selfsigned-certificate-deployment'), '2019-10-01').outputs.secretName.value)]"
            },
            "sslCertPwdSecretName": {
              "type": "string",
              "value": "[if(parameters('useExistingAppGatewaySSLCertificate'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-existing-certificate-deployment'), '2019-10-01').outputs.sslCertPwdSecretName.value, '')]"
            },
            "sslBackendCertDataSecretName": {
              "type": "string",
              "value": "[if(parameters('enableCustomSSL'), reference(resourceId('Microsoft.Resources/deployments', 'kv-appgw-e2e-ssl-backend-certificate'), '2019-10-01').outputs.sslBackendCertDataSecretName.value, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster')]",
        "[resourceId('Microsoft.Resources/deployments', 'setup-wls-cluster-with-custom-ssl-enabled')]"
      ]
    },
    {
      "condition": "[variables('const_enableNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "networking-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidNetworkingEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.networkingEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.networkingEnd.value)]"
          },
          "_pidNetworkingStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.networkingStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.networkingStart.value)]"
          },
          "_pidAppgwEnd": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.appgwEnd.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.appgwEnd.value)]"
          },
          "_pidAppgwStart": {
            "value": "[if(equals(reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.appgwStart.value, ''), variables('name_defaultPidDeployment'), reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.appgwStart.value)]"
          },
          "aksClusterRGName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value]"
          },
          "appGatewayCertificateOption": {
            "value": "[parameters('appGatewayCertificateOption')]"
          },
          "appGatewayPublicIPAddressName": {
            "value": "[parameters('appGatewayPublicIPAddressName')]"
          },
          "appGatewaySubnetId": {
            "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway'), '2019-10-01').outputs.subIdForApplicationGateway.value, '')]"
          },
          "appGatewaySubnetStartAddress": {
            "value": "[variables('_appGatewaySubnetStartAddress')]"
          },
          "appgwForAdminServer": {
            "value": "[parameters('appgwForAdminServer')]"
          },
          "appgwForRemoteConsole": {
            "value": "[parameters('appgwForRemoteConsole')]"
          },
          "createDNSZone": {
            "value": "[parameters('createDNSZone')]"
          },
          "dnsNameforApplicationGateway": {
            "value": "[variables('name_domainLabelforApplicationGateway')]"
          },
          "dnszoneAdminConsoleLabel": {
            "value": "[parameters('dnszoneAdminConsoleLabel')]"
          },
          "dnszoneAdminT3ChannelLabel": {
            "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
          },
          "dnszoneClusterLabel": {
            "value": "[parameters('dnszoneClusterLabel')]"
          },
          "dnszoneClusterT3ChannelLabel": {
            "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
          },
          "dnszoneName": {
            "value": "[parameters('dnszoneName')]"
          },
          "dnszoneRGName": {
            "value": "[parameters('dnszoneRGName')]"
          },
          "enableAppGWIngress": {
            "value": "[parameters('enableAppGWIngress')]"
          },
          "enableCookieBasedAffinity": {
            "value": "[parameters('enableCookieBasedAffinity')]"
          },
          "enableCustomSSL": {
            "value": "[parameters('enableCustomSSL')]"
          },
          "enableDNSConfiguration": {
            "value": "[parameters('enableDNSConfiguration')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "keyVaultName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2019-10-01').outputs.keyVaultName.value)]"
          },
          "keyVaultResourceGroup": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultResourceGroup'), resourceGroup().name)]"
          },
          "keyvaultBackendCertDataSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLBackendRootCertDataSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2019-10-01').outputs.sslBackendCertDataSecretName.value)]"
          },
          "keyVaultSSLCertDataSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLCertDataSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2019-10-01').outputs.sslCertDataSecretName.value)]"
          },
          "keyVaultSSLCertPasswordSecretName": {
            "value": "[if(or(not(parameters('enableAppGWIngress')), equals(parameters('appGatewayCertificateOption'), variables('const_appGatewaySSLCertOptionHaveKeyVault'))), parameters('keyVaultSSLCertPasswordSecretName'), reference(resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment'), '2019-10-01').outputs.sslCertPwdSecretName.value)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "lbSvcValues": {
            "value": "[parameters('lbSvcValues')]"
          },
          "servicePrincipal": {
            "value": "[parameters('servicePrincipal')]"
          },
          "useInternalLB": {
            "value": "[parameters('useInternalLB')]"
          },
          "appgwUsePrivateIP": {
            "value": "[parameters('appgwUsePrivateIP')]"
          },
          "wlsDomainName": {
            "value": "[parameters('wlsDomainName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "236066404791090005"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidAppgwEnd": {
              "type": "string",
              "defaultValue": "pid-networking-appgateway-end"
            },
            "_pidAppgwStart": {
              "type": "string",
              "defaultValue": "pid-networking-appgateway-start"
            },
            "_pidDnsEnd": {
              "type": "string",
              "defaultValue": "pid-networking-dns-end"
            },
            "_pidDnsStart": {
              "type": "string",
              "defaultValue": "pid-networking-dns-start"
            },
            "_pidLbEnd": {
              "type": "string",
              "defaultValue": "pid-networking-lb-end"
            },
            "_pidLbStart": {
              "type": "string",
              "defaultValue": "pid-networking-lb-start"
            },
            "_pidNetworkingEnd": {
              "type": "string",
              "defaultValue": "pid-networking-end"
            },
            "_pidNetworkingStart": {
              "type": "string",
              "defaultValue": "pid-networking-start"
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": "aks-contoso-rg",
              "metadata": {
                "description": "Resource group name of an existing AKS cluster."
              }
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "aks-contoso",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "appGatewayCertificateOption": {
              "type": "string",
              "defaultValue": "haveCert",
              "metadata": {
                "description": "Three scenarios we support for deploying app gateway"
              },
              "allowedValues": [
                "haveCert",
                "haveKeyVault",
                "generateCert"
              ]
            },
            "appGatewayPublicIPAddressName": {
              "type": "string",
              "defaultValue": "gwip",
              "metadata": {
                "description": "Public IP Name for the Application Gateway"
              }
            },
            "appGatewaySubnetId": {
              "type": "string",
              "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
            },
            "appGatewaySubnetStartAddress": {
              "type": "string",
              "defaultValue": "10.0.0.1"
            },
            "appgwForAdminServer": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Create Application Gateway ingress for admin console."
              }
            },
            "appgwForRemoteConsole": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Create Application Gateway ingress for remote console."
              }
            },
            "appgwUsePrivateIP": {
              "type": "bool",
              "defaultValue": false
            },
            "createDNSZone": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "If true, the template will update records to the existing DNS Zone. If false, the template will create a new DNS Zone."
              }
            },
            "dnsNameforApplicationGateway": {
              "type": "string",
              "defaultValue": "wlsgw",
              "metadata": {
                "description": "DNS prefix for ApplicationGateway"
              }
            },
            "dnszoneName": {
              "type": "string",
              "defaultValue": "contoso.xyz",
              "metadata": {
                "description": "Azure DNS Zone name."
              }
            },
            "dnszoneAdminConsoleLabel": {
              "type": "string",
              "defaultValue": "admin"
            },
            "dnszoneAdminT3ChannelLabel": {
              "type": "string",
              "defaultValue": "admin-t3"
            },
            "dnszoneClusterLabel": {
              "type": "string",
              "defaultValue": "www",
              "metadata": {
                "description": "Specify a label used to generate subdomain of WebLogic cluster. The final subdomain name will be label.dnszoneName, e.g. applications.contoso.xyz"
              }
            },
            "dnszoneClusterT3ChannelLabel": {
              "type": "string",
              "defaultValue": "cluster-t3"
            },
            "dnszoneRGName": {
              "type": "string",
              "defaultValue": "dns-contoso-rg"
            },
            "enableAppGWIngress": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "true to set up Application Gateway ingress."
              }
            },
            "enableCookieBasedAffinity": {
              "type": "bool",
              "defaultValue": false
            },
            "enableCustomSSL": {
              "type": "bool",
              "defaultValue": false
            },
            "enableDNSConfiguration": {
              "type": "bool",
              "defaultValue": false
            },
            "identity": {
              "type": "object"
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "kv-contoso",
              "metadata": {
                "description": "Existing Key Vault Name"
              }
            },
            "keyVaultResourceGroup": {
              "type": "string",
              "defaultValue": "kv-contoso-rg",
              "metadata": {
                "description": "Resource group name in current subscription containing the KeyVault"
              }
            },
            "keyvaultBackendCertDataSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-backend-data"
            },
            "keyVaultSSLCertDataSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-data",
              "metadata": {
                "description": "The name of the secret in the specified KeyVault whose value is the SSL Certificate Data"
              }
            },
            "keyVaultSSLCertPasswordSecretName": {
              "type": "string",
              "defaultValue": "kv-ssl-psw",
              "metadata": {
                "description": "The name of the secret in the specified KeyVault whose value is the password for the SSL Certificate"
              }
            },
            "location": {
              "type": "string"
            },
            "lbSvcValues": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Object array to define Load Balancer service, each object must include service name, service target[admin-server or cluster-1], port."
              }
            },
            "servicePrincipal": {
              "type": "secureString",
              "defaultValue": "[newGuid()]"
            },
            "useInternalLB": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "True to set up internal load balancer service."
              }
            },
            "wlsDomainName": {
              "type": "string",
              "defaultValue": "domain1",
              "metadata": {
                "description": "Name of WebLogic domain to create."
              }
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            }
          },
          "functions": [],
          "variables": {
            "_enableAppGWIngress": "[parameters('enableAppGWIngress')]",
            "_appgwUsePrivateIP": "[parameters('appgwUsePrivateIP')]",
            "const_appgwCustomDNSAlias": "[format('{0}.{1}/', parameters('dnszoneClusterLabel'), parameters('dnszoneName'))]",
            "const_appgwAdminCustomDNSAlias": "[format('{0}.{1}/', parameters('dnszoneAdminConsoleLabel'), parameters('dnszoneName'))]",
            "const_appgwSSLCertOptionGenerateCert": "generateCert",
            "const_enableLbService": "[greater(length(parameters('lbSvcValues')), 0)]",
            "name_networkDeployment": "[if(variables('_enableAppGWIngress'), if(equals(parameters('appGatewayCertificateOption'), variables('const_appgwSSLCertOptionGenerateCert')), 'ds-networking-deployment-1', 'ds-networking-deployment'), 'ds-networking-deployment-2')]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-networking-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidNetworkingStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-app-gateway-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidAppgwStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[variables('const_enableLbService')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-loadbalancer-service-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidLbStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableDNSConfiguration')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-dns-start-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidDnsStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('appgwUsePrivateIP')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "query-available-private-ip-for-app-gateway",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetId": {
                    "value": "[parameters('appGatewaySubnetId')]"
                  },
                  "knownIP": {
                    "value": "[parameters('appGatewaySubnetStartAddress')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "5848700562633244233"
                    }
                  },
                  "parameters": {
                    "subnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "knownIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "identity": {
                      "type": "object"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_azcliVersion": "2.15.0",
                    "const_deploymentName": "ds-query-private-ip"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[variables('const_deploymentName')]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[variables('const_azcliVersion')]",
                        "scriptContent": "[format('{0}\r\n\r\n{1}', '# Copyright (c) 2021, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n\nexport checkPodStatusInterval=20 # interval of checking pod status.\nexport checkPodStatusMaxAttemps=50 # max attempt to check pod status.\nexport checkPVStateInterval=5 # interval of checking pvc status.\nexport checkPVStateMaxAttempt=10 # max attempt to check pvc status.\nexport checkSVCStateMaxAttempt=50\nexport checkSVCInterval=30 #seconds\n\nexport constAdminT3AddressEnvName=\"T3_TUNNELING_ADMIN_ADDRESS\"\nexport constAdminServerName=''admin-server''\nexport constClusterName=''cluster-1''\nexport constClusterT3AddressEnvName=\"T3_TUNNELING_CLUSTER_ADDRESS\"\nexport constDefaultJavaOptions=\"-Dlog4j2.formatMsgNoLookups=true -Dweblogic.StdoutDebugEnabled=false\" # the java options will be applied to the cluster\nexport constDefaultJVMArgs=\"-Djava.security.egd=file:/dev/./urandom -Xms256m -Xmx512m -XX:MinRAMPercentage=25.0 -XX:MaxRAMPercentage=50.0 \" # the JVM options will be applied to the cluster\nexport constDefaultAKSVersion=\"default\"\nexport constFalse=\"false\"\nexport constTrue=\"true\"\nexport constIntrospectorJobActiveDeadlineSeconds=300  # for Guaranteed Qos\nexport constPostgreDriverName=\"postgresql-42.3.6.jar\"\nexport constMSSQLDriverName=\"mssql-jdbc-10.2.1.jre8.jar\"\n\nexport curlMaxTime=120 # seconds\nexport ocrLoginServer=\"container-registry.oracle.com\"\nexport ocrGaImagePath=\"middleware/weblogic\"\nexport ocrCpuImagePath=\"middleware/weblogic_cpu\"\nexport gitUrl4CpuImages=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/weblogic_cpu_images.json\"\nexport gitUrl4AksWellTestedVersionJsonFile=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/aks_well_tested_version.json\"\nexport gitUrl4WLSToolingFamilyJsonFile=\"https://raw.githubusercontent.com/oracle/weblogic-azure/main/weblogic-azure-aks/src/main/resources/weblogic_tooling_family.json\"\n\nexport optUninstallMaxTry=5 # Max attempts to wait for the operator uninstalled\nexport optUninstallInterval=10\n\nexport wlsContainerName=\"weblogic-server\"\nexport wlsPostgresqlDriverUrl=\"https://jdbc.postgresql.org/download/postgresql-42.3.6.jar\"\nexport wlsMSSQLDriverUrl=\"https://repo.maven.apache.org/maven2/com/microsoft/sqlserver/mssql-jdbc/10.2.1.jre8/mssql-jdbc-10.2.1.jre8.jar\"\n', '# Copyright (c) 2022, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n#\n# env inputs:\n# SUBNET_ID\n# KNOWN_IP\n\nfunction query_ip() {\n    echo_stdout \"Subnet Id: ${SUBNET_ID}\"\n\n    # select a available private IP\n    # azure reserves the first 3 private IPs.\n    local ret=$(az network vnet check-ip-address \\\n        --ids ${SUBNET_ID} \\\n        --ip-address ${KNOWN_IP})\n    local available=$(echo ${ret} | jq -r .available)\n    if [[ \"${available,,}\" == \"true\" ]]; then\n      outputPrivateIP=${KNOWN_IP}\n    else\n      local privateIPAddress=$(echo ${ret} | jq -r .availableIpAddresses[0])\n      if [[ -z \"${privateIPAddress}\" ]] || [[ \"${privateIPAddress}\"==\"null\" ]]; then\n        echo_stderr \"ERROR: make sure there is available IP for application gateway in your subnet.\"\n      fi\n\n      outputPrivateIP=${privateIPAddress}\n    fi\n}\n\nfunction output_result() {\n  echo \"Available Private IP: ${outputPrivateIP}\"\n  result=$(jq -n -c \\\n    --arg privateIP \"$outputPrivateIP\" \\\n    ''{privateIP: $privateIP}'')\n  echo \"result is: $result\"\n  echo $result >$AZ_SCRIPTS_OUTPUT_PATH\n}\n\n# main script\noutputPrivateIP=\"10.0.0.1\"\n\nquery_ip\n\noutput_result')]",
                        "environmentVariables": [
                          {
                            "name": "SUBNET_ID",
                            "value": "[parameters('subnetId')]"
                          },
                          {
                            "name": "KNOWN_IP",
                            "value": "[parameters('knownIP')]"
                          }
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "privateIP": {
                      "type": "string",
                      "value": "[string(reference(variables('const_deploymentName')).outputs.privateIP)]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "app-gateway-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnsNameforApplicationGateway": {
                    "value": "[parameters('dnsNameforApplicationGateway')]"
                  },
                  "gatewayPublicIPAddressName": {
                    "value": "[parameters('appGatewayPublicIPAddressName')]"
                  },
                  "gatewaySubnetId": {
                    "value": "[parameters('appGatewaySubnetId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "staticPrivateFrontentIP": {
                    "value": "[if(variables('_appgwUsePrivateIP'), reference(resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway'), '2019-10-01').outputs.privateIP.value, '')]"
                  },
                  "usePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "2065533916820553259"
                    }
                  },
                  "parameters": {
                    "dnsNameforApplicationGateway": {
                      "type": "string",
                      "defaultValue": "[take(format('wlsgw{0}', uniqueString(parameters('utcValue'))), 63)]",
                      "metadata": {
                        "description": "DNS for ApplicationGateway"
                      }
                    },
                    "gatewayPublicIPAddressName": {
                      "type": "string",
                      "defaultValue": "gwip",
                      "metadata": {
                        "description": "Public IP Name for the Application Gateway"
                      }
                    },
                    "gatewaySubnetId": {
                      "type": "string",
                      "defaultValue": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroupname/providers/Microsoft.Network/virtualNetworks/vnetname/subnets/subnetname"
                    },
                    "location": {
                      "type": "string"
                    },
                    "staticPrivateFrontentIP": {
                      "type": "string",
                      "defaultValue": "10.0.0.1"
                    },
                    "usePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "name_appGateway": "[format('appgw{0}', uniqueString(parameters('utcValue')))]",
                    "name_backendAddressPool": "myGatewayBackendPool",
                    "name_frontEndIPConfig": "appGwPublicFrontendIp",
                    "name_frontEndPrivateIPConfig": "appGwPrivateFrontendIp",
                    "name_httpListener": "HTTPListener",
                    "name_httpPort": "httpport",
                    "name_httpSetting": "myHTTPSetting",
                    "ref_backendAddressPool": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('name_appGateway'), variables('name_backendAddressPool'))]",
                    "ref_backendHttpSettings": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('name_appGateway'), variables('name_httpSetting'))]",
                    "ref_frontendHTTPPort": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('name_appGateway'), variables('name_httpPort'))]",
                    "ref_frontendIPConfiguration": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('name_appGateway'), variables('name_frontEndIPConfig'))]",
                    "ref_httpListener": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('name_appGateway'), variables('name_httpListener'))]",
                    "ref_publicIPAddress": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]",
                    "obj_frontendIPConfigurations1": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      }
                    ],
                    "obj_frontendIPConfigurations2": [
                      {
                        "name": "[variables('name_frontEndIPConfig')]",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('ref_publicIPAddress')]"
                          }
                        }
                      },
                      {
                        "name": "[variables('name_frontEndPrivateIPConfig')]",
                        "properties": {
                          "privateIPAllocationMethod": "Static",
                          "privateIPAddress": "[parameters('staticPrivateFrontentIP')]",
                          "subnet": {
                            "id": "[parameters('gatewaySubnetId')]"
                          }
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2020-07-01",
                      "name": "[parameters('gatewayPublicIPAddressName')]",
                      "sku": {
                        "name": "Standard"
                      },
                      "location": "[parameters('location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsNameforApplicationGateway')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/applicationGateways",
                      "apiVersion": "2020-07-01",
                      "name": "[variables('name_appGateway')]",
                      "location": "[parameters('location')]",
                      "tags": {
                        "managed-by-k8s-ingress": "true"
                      },
                      "properties": {
                        "sku": {
                          "name": "WAF_v2",
                          "tier": "WAF_v2"
                        },
                        "gatewayIPConfigurations": [
                          {
                            "name": "appGatewayIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('gatewaySubnetId')]"
                              }
                            }
                          }
                        ],
                        "frontendIPConfigurations": "[if(parameters('usePrivateIP'), variables('obj_frontendIPConfigurations2'), variables('obj_frontendIPConfigurations1'))]",
                        "frontendPorts": [
                          {
                            "name": "[variables('name_httpPort')]",
                            "properties": {
                              "port": 80
                            }
                          }
                        ],
                        "backendAddressPools": [
                          {
                            "name": "myGatewayBackendPool"
                          }
                        ],
                        "httpListeners": [
                          {
                            "name": "[variables('name_httpListener')]",
                            "properties": {
                              "protocol": "Http",
                              "frontendIPConfiguration": {
                                "id": "[variables('ref_frontendIPConfiguration')]"
                              },
                              "frontendPort": {
                                "id": "[variables('ref_frontendHTTPPort')]"
                              }
                            }
                          }
                        ],
                        "backendHttpSettingsCollection": [
                          {
                            "name": "[variables('name_httpSetting')]",
                            "properties": {
                              "port": 80,
                              "protocol": "Http"
                            }
                          }
                        ],
                        "requestRoutingRules": [
                          {
                            "name": "HTTPRoutingRule",
                            "properties": {
                              "httpListener": {
                                "id": "[variables('ref_httpListener')]"
                              },
                              "backendAddressPool": {
                                "id": "[variables('ref_backendAddressPool')]"
                              },
                              "backendHttpSettings": {
                                "id": "[variables('ref_backendHttpSettings')]"
                              }
                            }
                          }
                        ],
                        "webApplicationFirewallConfiguration": {
                          "enabled": true,
                          "firewallMode": "Prevention",
                          "ruleSetType": "OWASP",
                          "ruleSetVersion": "3.0"
                        },
                        "enableHttp2": false,
                        "autoscaleConfiguration": {
                          "minCapacity": 2,
                          "maxCapacity": 3
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "appGatewayAlias": {
                      "type": "string",
                      "value": "[if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)]"
                    },
                    "appGatewayName": {
                      "type": "string",
                      "value": "[variables('name_appGateway')]"
                    },
                    "appGatewayURL": {
                      "type": "string",
                      "value": "[uri(format('http://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    },
                    "appGatewaySecuredURL": {
                      "type": "string",
                      "value": "[uri(format('https://{0}/', if(parameters('usePrivateIP'), parameters('staticPrivateFrontentIP'), reference(resourceId('Microsoft.Network/publicIPAddresses', parameters('gatewayPublicIPAddressName'))).dnsSettings.fqdn)), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-app-gateway-start-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'pid-loadbalancer-service-start-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'query-available-private-ip-for-app-gateway')]"
              ]
            },
            {
              "condition": "[and(parameters('enableAppGWIngress'), parameters('enableCustomSSL'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "app-gateway-backend-cert-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "appgwName": {
                    "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayName.value, 'null')]"
                  },
                  "sslBackendRootCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyvaultBackendCertDataSecretName')]"
                    }
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "16356037709298836565"
                    }
                  },
                  "parameters": {
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "sslBackendRootCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "identity": {
                      "type": "object"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_arguments": "[format('{0} {1} {2}', resourceGroup().name, parameters('appgwName'), parameters('sslBackendRootCertData'))]",
                    "const_azcliVersion": "2.15.0",
                    "const_deploymentName": "ds-upload-trusted-root-certificatre-to-gateway"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[variables('const_deploymentName')]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[variables('const_azcliVersion')]",
                        "arguments": "[variables('const_arguments')]",
                        "scriptContent": "# Copyright (c) 2021, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n\n# upload trusted root certificate to Azure Application Gateway\n# $1: resource group name\n# $2: Application Gateway name\n# $3: one line based64 string of the certificate data\n\n# The value is used in setupNetworking.sh, please do not change it.\nexport appgwBackendSecretName='backend-tls'\n\necho \"output certificate data to backend-cert.cer\"\necho \"$3\" | base64 -d >backend-cert.cer\n\naz network application-gateway root-cert create \\\n      --gateway-name $2  \\\n      --resource-group $1 \\\n      --name ${appgwBackendSecretName} \\\n      --cert-file backend-cert.cer\n\nif [ $? -ne 0 ]; then\n    echo \"Failed to upload trusted root certificate to Application Gateway ${2}\"\n    exit 1\nfi\n",
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment')]"
              ]
            },
            {
              "condition": "[and(parameters('enableDNSConfiguration'), parameters('createDNSZone'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "dnszone-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "15967509283427304459"
                    }
                  },
                  "parameters": {
                    "dnszoneName": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure DNS Zone name."
                      }
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/dnsZones",
                      "apiVersion": "2018-05-01",
                      "name": "[parameters('dnszoneName')]",
                      "location": "global",
                      "properties": {
                        "zoneType": "Public"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-dns-start-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'pid-networking-start-deployment')]"
              ]
            },
            {
              "condition": "[and(parameters('enableAppGWIngress'), not(equals(parameters('appGatewayCertificateOption'), variables('const_appgwSSLCertOptionGenerateCert'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "ds-networking-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "appgwName": {
                    "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayName.value, 'null')]"
                  },
                  "appgwAlias": {
                    "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayAlias.value, 'null')]"
                  },
                  "appgwCertificateOption": {
                    "value": "[parameters('appGatewayCertificateOption')]"
                  },
                  "appgwForAdminServer": {
                    "value": "[parameters('appgwForAdminServer')]"
                  },
                  "appgwForRemoteConsole": {
                    "value": "[parameters('appgwForRemoteConsole')]"
                  },
                  "appgwFrontendSSLCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyVaultSSLCertDataSecretName')]"
                    }
                  },
                  "appgwFrontendSSLCertPsw": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyVaultSSLCertPasswordSecretName')]"
                    }
                  },
                  "appgwUsePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "dnszoneAdminConsoleLabel": {
                    "value": "[parameters('dnszoneAdminConsoleLabel')]"
                  },
                  "dnszoneAdminT3ChannelLabel": {
                    "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                  },
                  "dnszoneClusterLabel": {
                    "value": "[parameters('dnszoneClusterLabel')]"
                  },
                  "dnszoneClusterT3ChannelLabel": {
                    "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                  },
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  },
                  "dnszoneRGName": {
                    "value": "[if(parameters('createDNSZone'), resourceGroup().name, parameters('dnszoneRGName'))]"
                  },
                  "enableAppGWIngress": {
                    "value": "[parameters('enableAppGWIngress')]"
                  },
                  "enableCookieBasedAffinity": {
                    "value": "[parameters('enableCookieBasedAffinity')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableDNSConfiguration": {
                    "value": "[parameters('enableDNSConfiguration')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "lbSvcValues": {
                    "value": "[parameters('lbSvcValues')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "servicePrincipal": {
                    "value": "[parameters('servicePrincipal')]"
                  },
                  "useInternalLB": {
                    "value": "[parameters('useInternalLB')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "17195506643166678313"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "appgwAlias": {
                      "type": "string",
                      "defaultValue": "appgw-contoso-alias"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "appgwCertificateOption": {
                      "type": "string",
                      "defaultValue": "haveCert",
                      "metadata": {
                        "description": "Three scenarios we support for deploying app gateway"
                      },
                      "allowedValues": [
                        "haveCert",
                        "haveKeyVault",
                        "generateCert"
                      ]
                    },
                    "appgwForAdminServer": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwForRemoteConsole": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwFrontendSSLCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwFrontendSSLCertPsw": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwUsePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": "aks-contoso-rg"
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": "aks-contoso"
                    },
                    "dnszoneAdminConsoleLabel": {
                      "type": "string",
                      "defaultValue": "admin"
                    },
                    "dnszoneAdminT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "admin-t3"
                    },
                    "dnszoneClusterLabel": {
                      "type": "string",
                      "defaultValue": "www"
                    },
                    "dnszoneClusterT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "cluster-t3"
                    },
                    "dnszoneName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz"
                    },
                    "dnszoneRGName": {
                      "type": "string",
                      "defaultValue": "dns-contoso-rg"
                    },
                    "enableAppGWIngress": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCookieBasedAffinity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableDNSConfiguration": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object"
                    },
                    "lbSvcValues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "location": {
                      "type": "string"
                    },
                    "servicePrincipal": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "useInternalLB": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_appgwHelmConfigTemplate": "appgw-helm-config.yaml.template",
                    "const_appgwSARoleBindingFile": "appgw-ingress-clusterAdmin-roleBinding.yaml",
                    "const_arguments": "[format('{0} {1} {2} {3} \"{4}\" {5} {6} {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} {18} {19} {20} {21} {22} {23} {24} {25} {26}', parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('wlsDomainName'), parameters('wlsDomainUID'), string(parameters('lbSvcValues')), parameters('enableAppGWIngress'), subscription().id, resourceGroup().name, parameters('appgwName'), parameters('appgwUsePrivateIP'), string(parameters('servicePrincipal')), parameters('appgwForAdminServer'), parameters('enableDNSConfiguration'), parameters('dnszoneRGName'), parameters('dnszoneName'), parameters('dnszoneAdminConsoleLabel'), parameters('dnszoneClusterLabel'), parameters('appgwAlias'), parameters('useInternalLB'), parameters('appgwFrontendSSLCertData'), parameters('appgwFrontendSSLCertPsw'), parameters('appgwCertificateOption'), parameters('enableCustomSSL'), parameters('enableCookieBasedAffinity'), parameters('appgwForRemoteConsole'), parameters('dnszoneAdminT3ChannelLabel'), parameters('dnszoneClusterT3ChannelLabel'))]",
                    "const_commonScript": "common.sh",
                    "const_createDnsRecordScript": "createDnsRecord.sh",
                    "const_createLbSvcScript": "createLbSvc.sh",
                    "const_createGatewayIngressSvcScript": "createAppGatewayIngress.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_setupNetworkingScript": "setupNetworking.sh",
                    "const_primaryScript": "invokeSetupNetworking.sh",
                    "const_utilityScript": "utility.sh",
                    "name_deploymentName": "ds-networking-deployment"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-networking-deployment",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "2.15.0",
                        "arguments": "[variables('const_arguments')]",
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_primaryScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setupNetworkingScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwHelmConfigTemplate'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwSARoleBindingFile'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createDnsRecordScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createLbSvcScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createGatewayIngressSvcScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminConsoleLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminConsoleLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminServerT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, '')]"
                    },
                    "adminRemoteEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('http://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "adminRemoteSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('https://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "clusterLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-backend-cert-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'dnszone-deployment')]"
              ]
            },
            {
              "condition": "[and(parameters('enableAppGWIngress'), equals(parameters('appGatewayCertificateOption'), variables('const_appgwSSLCertOptionGenerateCert')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "ds-networking-deployment-1",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "appgwName": {
                    "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayName.value, 'null')]"
                  },
                  "appgwAlias": {
                    "value": "[if(variables('_enableAppGWIngress'), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayAlias.value, 'null')]"
                  },
                  "appgwCertificateOption": {
                    "value": "[parameters('appGatewayCertificateOption')]"
                  },
                  "appgwForAdminServer": {
                    "value": "[parameters('appgwForAdminServer')]"
                  },
                  "appgwForRemoteConsole": {
                    "value": "[parameters('appgwForRemoteConsole')]"
                  },
                  "appgwFrontendSSLCertData": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroup')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      },
                      "secretName": "[parameters('keyVaultSSLCertDataSecretName')]"
                    }
                  },
                  "appgwFrontendSSLCertPsw": {
                    "value": "null"
                  },
                  "appgwUsePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "dnszoneAdminConsoleLabel": {
                    "value": "[parameters('dnszoneAdminConsoleLabel')]"
                  },
                  "dnszoneAdminT3ChannelLabel": {
                    "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                  },
                  "dnszoneClusterLabel": {
                    "value": "[parameters('dnszoneClusterLabel')]"
                  },
                  "dnszoneClusterT3ChannelLabel": {
                    "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                  },
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  },
                  "dnszoneRGName": {
                    "value": "[if(parameters('createDNSZone'), resourceGroup().name, parameters('dnszoneRGName'))]"
                  },
                  "enableAppGWIngress": {
                    "value": "[parameters('enableAppGWIngress')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableCookieBasedAffinity": {
                    "value": "[parameters('enableCookieBasedAffinity')]"
                  },
                  "enableDNSConfiguration": {
                    "value": "[parameters('enableDNSConfiguration')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "lbSvcValues": {
                    "value": "[parameters('lbSvcValues')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "servicePrincipal": {
                    "value": "[parameters('servicePrincipal')]"
                  },
                  "useInternalLB": {
                    "value": "[parameters('useInternalLB')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "17195506643166678313"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "appgwAlias": {
                      "type": "string",
                      "defaultValue": "appgw-contoso-alias"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "appgwCertificateOption": {
                      "type": "string",
                      "defaultValue": "haveCert",
                      "metadata": {
                        "description": "Three scenarios we support for deploying app gateway"
                      },
                      "allowedValues": [
                        "haveCert",
                        "haveKeyVault",
                        "generateCert"
                      ]
                    },
                    "appgwForAdminServer": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwForRemoteConsole": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwFrontendSSLCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwFrontendSSLCertPsw": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwUsePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": "aks-contoso-rg"
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": "aks-contoso"
                    },
                    "dnszoneAdminConsoleLabel": {
                      "type": "string",
                      "defaultValue": "admin"
                    },
                    "dnszoneAdminT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "admin-t3"
                    },
                    "dnszoneClusterLabel": {
                      "type": "string",
                      "defaultValue": "www"
                    },
                    "dnszoneClusterT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "cluster-t3"
                    },
                    "dnszoneName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz"
                    },
                    "dnszoneRGName": {
                      "type": "string",
                      "defaultValue": "dns-contoso-rg"
                    },
                    "enableAppGWIngress": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCookieBasedAffinity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableDNSConfiguration": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object"
                    },
                    "lbSvcValues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "location": {
                      "type": "string"
                    },
                    "servicePrincipal": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "useInternalLB": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_appgwHelmConfigTemplate": "appgw-helm-config.yaml.template",
                    "const_appgwSARoleBindingFile": "appgw-ingress-clusterAdmin-roleBinding.yaml",
                    "const_arguments": "[format('{0} {1} {2} {3} \"{4}\" {5} {6} {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} {18} {19} {20} {21} {22} {23} {24} {25} {26}', parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('wlsDomainName'), parameters('wlsDomainUID'), string(parameters('lbSvcValues')), parameters('enableAppGWIngress'), subscription().id, resourceGroup().name, parameters('appgwName'), parameters('appgwUsePrivateIP'), string(parameters('servicePrincipal')), parameters('appgwForAdminServer'), parameters('enableDNSConfiguration'), parameters('dnszoneRGName'), parameters('dnszoneName'), parameters('dnszoneAdminConsoleLabel'), parameters('dnszoneClusterLabel'), parameters('appgwAlias'), parameters('useInternalLB'), parameters('appgwFrontendSSLCertData'), parameters('appgwFrontendSSLCertPsw'), parameters('appgwCertificateOption'), parameters('enableCustomSSL'), parameters('enableCookieBasedAffinity'), parameters('appgwForRemoteConsole'), parameters('dnszoneAdminT3ChannelLabel'), parameters('dnszoneClusterT3ChannelLabel'))]",
                    "const_commonScript": "common.sh",
                    "const_createDnsRecordScript": "createDnsRecord.sh",
                    "const_createLbSvcScript": "createLbSvc.sh",
                    "const_createGatewayIngressSvcScript": "createAppGatewayIngress.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_setupNetworkingScript": "setupNetworking.sh",
                    "const_primaryScript": "invokeSetupNetworking.sh",
                    "const_utilityScript": "utility.sh",
                    "name_deploymentName": "ds-networking-deployment"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-networking-deployment",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "2.15.0",
                        "arguments": "[variables('const_arguments')]",
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_primaryScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setupNetworkingScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwHelmConfigTemplate'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwSARoleBindingFile'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createDnsRecordScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createLbSvcScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createGatewayIngressSvcScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminConsoleLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminConsoleLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminServerT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, '')]"
                    },
                    "adminRemoteEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('http://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "adminRemoteSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('https://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "clusterLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-backend-cert-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'dnszone-deployment')]"
              ]
            },
            {
              "condition": "[not(parameters('enableAppGWIngress'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "ds-networking-deployment-2",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "appgwName": {
                    "value": "null"
                  },
                  "appgwAlias": {
                    "value": "null"
                  },
                  "appgwCertificateOption": {
                    "value": "[parameters('appGatewayCertificateOption')]"
                  },
                  "appgwForAdminServer": {
                    "value": "[parameters('appgwForAdminServer')]"
                  },
                  "appgwForRemoteConsole": {
                    "value": "[parameters('appgwForRemoteConsole')]"
                  },
                  "appgwFrontendSSLCertData": {
                    "value": "null"
                  },
                  "appgwFrontendSSLCertPsw": {
                    "value": "null"
                  },
                  "appgwUsePrivateIP": {
                    "value": "[parameters('appgwUsePrivateIP')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "dnszoneAdminConsoleLabel": {
                    "value": "[parameters('dnszoneAdminConsoleLabel')]"
                  },
                  "dnszoneAdminT3ChannelLabel": {
                    "value": "[parameters('dnszoneAdminT3ChannelLabel')]"
                  },
                  "dnszoneClusterLabel": {
                    "value": "[parameters('dnszoneClusterLabel')]"
                  },
                  "dnszoneClusterT3ChannelLabel": {
                    "value": "[parameters('dnszoneClusterT3ChannelLabel')]"
                  },
                  "dnszoneName": {
                    "value": "[parameters('dnszoneName')]"
                  },
                  "dnszoneRGName": {
                    "value": "[if(parameters('createDNSZone'), resourceGroup().name, parameters('dnszoneRGName'))]"
                  },
                  "enableAppGWIngress": {
                    "value": "[parameters('enableAppGWIngress')]"
                  },
                  "enableCookieBasedAffinity": {
                    "value": "[parameters('enableCookieBasedAffinity')]"
                  },
                  "enableCustomSSL": {
                    "value": "[parameters('enableCustomSSL')]"
                  },
                  "enableDNSConfiguration": {
                    "value": "[parameters('enableDNSConfiguration')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "lbSvcValues": {
                    "value": "[parameters('lbSvcValues')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "servicePrincipal": {
                    "value": "[parameters('servicePrincipal')]"
                  },
                  "useInternalLB": {
                    "value": "[parameters('useInternalLB')]"
                  },
                  "wlsDomainName": {
                    "value": "[parameters('wlsDomainName')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "17195506643166678313"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "appgwAlias": {
                      "type": "string",
                      "defaultValue": "appgw-contoso-alias"
                    },
                    "appgwName": {
                      "type": "string",
                      "defaultValue": "appgw-contoso"
                    },
                    "appgwCertificateOption": {
                      "type": "string",
                      "defaultValue": "haveCert",
                      "metadata": {
                        "description": "Three scenarios we support for deploying app gateway"
                      },
                      "allowedValues": [
                        "haveCert",
                        "haveKeyVault",
                        "generateCert"
                      ]
                    },
                    "appgwForAdminServer": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwForRemoteConsole": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "appgwFrontendSSLCertData": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwFrontendSSLCertPsw": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "appgwUsePrivateIP": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "aksClusterRGName": {
                      "type": "string",
                      "defaultValue": "aks-contoso-rg"
                    },
                    "aksClusterName": {
                      "type": "string",
                      "defaultValue": "aks-contoso"
                    },
                    "dnszoneAdminConsoleLabel": {
                      "type": "string",
                      "defaultValue": "admin"
                    },
                    "dnszoneAdminT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "admin-t3"
                    },
                    "dnszoneClusterLabel": {
                      "type": "string",
                      "defaultValue": "www"
                    },
                    "dnszoneClusterT3ChannelLabel": {
                      "type": "string",
                      "defaultValue": "cluster-t3"
                    },
                    "dnszoneName": {
                      "type": "string",
                      "defaultValue": "contoso.xyz"
                    },
                    "dnszoneRGName": {
                      "type": "string",
                      "defaultValue": "dns-contoso-rg"
                    },
                    "enableAppGWIngress": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCookieBasedAffinity": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableCustomSSL": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableDNSConfiguration": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "identity": {
                      "type": "object"
                    },
                    "lbSvcValues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "location": {
                      "type": "string"
                    },
                    "servicePrincipal": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "useInternalLB": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainName": {
                      "type": "string",
                      "defaultValue": "domain1"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_appgwHelmConfigTemplate": "appgw-helm-config.yaml.template",
                    "const_appgwSARoleBindingFile": "appgw-ingress-clusterAdmin-roleBinding.yaml",
                    "const_arguments": "[format('{0} {1} {2} {3} \"{4}\" {5} {6} {7} {8} {9} {10} {11} {12} {13} {14} {15} {16} {17} {18} {19} {20} {21} {22} {23} {24} {25} {26}', parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('wlsDomainName'), parameters('wlsDomainUID'), string(parameters('lbSvcValues')), parameters('enableAppGWIngress'), subscription().id, resourceGroup().name, parameters('appgwName'), parameters('appgwUsePrivateIP'), string(parameters('servicePrincipal')), parameters('appgwForAdminServer'), parameters('enableDNSConfiguration'), parameters('dnszoneRGName'), parameters('dnszoneName'), parameters('dnszoneAdminConsoleLabel'), parameters('dnszoneClusterLabel'), parameters('appgwAlias'), parameters('useInternalLB'), parameters('appgwFrontendSSLCertData'), parameters('appgwFrontendSSLCertPsw'), parameters('appgwCertificateOption'), parameters('enableCustomSSL'), parameters('enableCookieBasedAffinity'), parameters('appgwForRemoteConsole'), parameters('dnszoneAdminT3ChannelLabel'), parameters('dnszoneClusterT3ChannelLabel'))]",
                    "const_commonScript": "common.sh",
                    "const_createDnsRecordScript": "createDnsRecord.sh",
                    "const_createLbSvcScript": "createLbSvc.sh",
                    "const_createGatewayIngressSvcScript": "createAppGatewayIngress.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_setupNetworkingScript": "setupNetworking.sh",
                    "const_primaryScript": "invokeSetupNetworking.sh",
                    "const_utilityScript": "utility.sh",
                    "name_deploymentName": "ds-networking-deployment"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-networking-deployment",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "2.15.0",
                        "arguments": "[variables('const_arguments')]",
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_primaryScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_setupNetworkingScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwHelmConfigTemplate'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_appgwSARoleBindingFile'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createDnsRecordScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createLbSvcScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_createGatewayIngressSvcScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "adminConsoleLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminConsoleLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.adminConsoleEndpoint), '')]"
                    },
                    "adminServerT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.adminServerT3Endpoint, '')]"
                    },
                    "adminRemoteEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('http://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "adminRemoteSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint, 'null'))), format('https://{0}', reference(variables('name_deploymentName')).outputs.adminRemoteEndpoint), '')]"
                    },
                    "clusterLBEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(not(parameters('enableCustomSSL')), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('http://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterLBSecuredEndpoint": {
                      "type": "string",
                      "value": "[if(and(and(parameters('enableCustomSSL'), greater(length(parameters('lbSvcValues')), 0)), not(equals(reference(variables('name_deploymentName')).outputs.clusterEndpoint, 'null'))), format('https://{0}/', reference(variables('name_deploymentName')).outputs.clusterEndpoint), '')]"
                    },
                    "clusterT3LBEndpoint": {
                      "type": "string",
                      "value": "[if(and(greater(length(parameters('lbSvcValues')), 0), not(equals(reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, 'null'))), reference(variables('name_deploymentName')).outputs.clusterT3Endpoint, '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'dnszone-deployment')]"
              ]
            },
            {
              "condition": "[parameters('enableAppGWIngress')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-app-gateway-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidAppgwEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment')]"
              ]
            },
            {
              "condition": "[variables('const_enableLbService')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-loadbalancer-service-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidLbEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-1')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-2')]"
              ]
            },
            {
              "condition": "[parameters('enableDNSConfiguration')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-dns-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidDnsEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-1')]",
                "[resourceId('Microsoft.Resources/deployments', 'ds-networking-deployment-2')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "pid-networking-end-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidNetworkingEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'pid-dns-end-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'pid-loadbalancer-service-end-deployment')]"
              ]
            }
          ],
          "outputs": {
            "adminConsoleExternalEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}console', variables('const_appgwAdminCustomDNSAlias')), format('http://{0}/console', reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayAlias.value)), reference(variables('name_networkDeployment')).outputs.adminConsoleLBEndpoint.value)]"
            },
            "adminConsoleExternalSecuredEndpoint": {
              "type": "string",
              "value": "[if(and(and(parameters('enableAppGWIngress'), parameters('enableCustomSSL')), parameters('enableDNSConfiguration')), format('https://{0}console', variables('const_appgwAdminCustomDNSAlias')), reference(variables('name_networkDeployment')).outputs.adminConsoleLBSecuredEndpoint.value)]"
            },
            "adminRemoteConsoleEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}remoteconsole', variables('const_appgwAdminCustomDNSAlias')), format('http://{0}/remoteconsole', reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayAlias.value)), reference(variables('name_networkDeployment')).outputs.adminRemoteEndpoint.value)]"
            },
            "adminRemoteConsoleSecuredEndpoint": {
              "type": "string",
              "value": "[if(and(and(parameters('enableAppGWIngress'), parameters('enableCustomSSL')), parameters('enableDNSConfiguration')), format('https://{0}remoteconsole', variables('const_appgwAdminCustomDNSAlias')), reference(variables('name_networkDeployment')).outputs.adminRemoteSecuredEndpoint.value)]"
            },
            "adminServerT3ChannelEndpoint": {
              "type": "string",
              "value": "[format('{0}://{1}', if(parameters('enableCustomSSL'), 't3s', 't3'), reference(variables('name_networkDeployment')).outputs.adminServerT3LBEndpoint.value)]"
            },
            "clusterExternalEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('http://{0}', variables('const_appgwCustomDNSAlias')), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewayURL.value), reference(variables('name_networkDeployment')).outputs.clusterLBEndpoint.value)]"
            },
            "clusterExternalSecuredEndpoint": {
              "type": "string",
              "value": "[if(parameters('enableAppGWIngress'), if(parameters('enableDNSConfiguration'), format('https://{0}', variables('const_appgwCustomDNSAlias')), reference(resourceId('Microsoft.Resources/deployments', 'app-gateway-deployment'), '2019-10-01').outputs.appGatewaySecuredURL.value), reference(variables('name_networkDeployment')).outputs.clusterLBSecuredEndpoint.value)]"
            },
            "clusterT3ChannelEndpoint": {
              "type": "string",
              "value": "[format('{0}://{1}', if(parameters('enableCustomSSL'), 't3s', 't3'), reference(variables('name_networkDeployment')).outputs.clusterT3LBEndpoint.value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appgateway-certificates-secrets-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]",
        "[resourceId('Microsoft.Resources/deployments', 'vnet-application-gateway')]"
      ]
    },
    {
      "condition": "[parameters('enableDB')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "datasource-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "_pidEnd": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.dbEnd.value]"
          },
          "_pidStart": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'initialization'), '2019-10-01').outputs.dbStart.value]"
          },
          "aksClusterRGName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value]"
          },
          "databaseType": {
            "value": "[parameters('databaseType')]"
          },
          "dbConfigurationType": {
            "value": "[parameters('dbConfigurationType')]"
          },
          "dbDriverName": {
            "value": "[parameters('dbDriverName')]"
          },
          "dbGlobalTranPro": {
            "value": "[parameters('dbGlobalTranPro')]"
          },
          "dbPassword": {
            "value": "[parameters('dbPassword')]"
          },
          "dbTestTableName": {
            "value": "[parameters('dbTestTableName')]"
          },
          "dbUser": {
            "value": "[parameters('dbUser')]"
          },
          "dsConnectionURL": {
            "value": "[parameters('dsConnectionURL')]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "jdbcDataSourceName": {
            "value": "[parameters('jdbcDataSourceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "15824002304978866294"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "_pidEnd": {
              "type": "string",
              "defaultValue": ""
            },
            "_pidStart": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of an existing AKS cluster."
              }
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "databaseType": {
              "type": "string",
              "defaultValue": "oracle",
              "metadata": {
                "description": "One of the supported database types"
              }
            },
            "dbConfigurationType": {
              "type": "string",
              "defaultValue": "createOrUpdate",
              "allowedValues": [
                "createOrUpdate",
                "delete"
              ]
            },
            "dbDriverName": {
              "type": "string",
              "defaultValue": "org.contoso.Driver",
              "metadata": {
                "description": "Datasource driver name"
              }
            },
            "dbGlobalTranPro": {
              "type": "string",
              "defaultValue": "EmulateTwoPhaseCommit",
              "metadata": {
                "description": "Determines the transaction protocol (global transaction processing behavior) for the data source."
              }
            },
            "dbPassword": {
              "type": "secureString",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Password for Database"
              }
            },
            "dbTestTableName": {
              "type": "string",
              "defaultValue": "Null",
              "metadata": {
                "description": "The name of the database table to use when testing physical database connections. This name is required when you specify a Test Frequency and enable Test Reserved Connections."
              }
            },
            "dbUser": {
              "type": "string",
              "defaultValue": "contosoDbUser",
              "metadata": {
                "description": "User id of Database"
              }
            },
            "dsConnectionURL": {
              "type": "string",
              "defaultValue": "jdbc:postgresql://contoso.postgres.database.azure.com:5432/postgres",
              "metadata": {
                "description": "JDBC Connection String"
              }
            },
            "identity": {
              "type": "object"
            },
            "jdbcDataSourceName": {
              "type": "string",
              "defaultValue": "jdbc/contoso",
              "metadata": {
                "description": "JNDI Name for JDBC Datasource"
              }
            },
            "location": {
              "type": "string"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1",
              "metadata": {
                "description": "UID of WebLogic domain, used in WebLogic Operator."
              }
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-db-start-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidStart')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "create-update-datasource",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksClusterRGName": {
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  "databaseType": {
                    "value": "[parameters('databaseType')]"
                  },
                  "dbConfigurationType": {
                    "value": "[parameters('dbConfigurationType')]"
                  },
                  "dbDriverName": {
                    "value": "[parameters('dbDriverName')]"
                  },
                  "dbGlobalTranPro": {
                    "value": "[parameters('dbGlobalTranPro')]"
                  },
                  "dbPassword": {
                    "value": "[parameters('dbPassword')]"
                  },
                  "dbTestTableName": {
                    "value": "[parameters('dbTestTableName')]"
                  },
                  "dbUser": {
                    "value": "[parameters('dbUser')]"
                  },
                  "dsConnectionURL": {
                    "value": "[parameters('dsConnectionURL')]"
                  },
                  "identity": {
                    "value": "[parameters('identity')]"
                  },
                  "jdbcDataSourceName": {
                    "value": "[parameters('jdbcDataSourceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "wlsDomainUID": {
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  "wlsPassword": {
                    "value": "[parameters('wlsPassword')]"
                  },
                  "wlsUserName": {
                    "value": "[parameters('wlsUserName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "13801512748644808684"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string",
                      "defaultValue": "[deployment().properties.templateLink.uri]"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "aksClusterName": {
                      "type": "string"
                    },
                    "aksClusterRGName": {
                      "type": "string"
                    },
                    "databaseType": {
                      "type": "string",
                      "defaultValue": "oracle"
                    },
                    "dbConfigurationType": {
                      "type": "string",
                      "defaultValue": "createOrUpdate"
                    },
                    "dbDriverName": {
                      "type": "string",
                      "defaultValue": "org.contoso.Driver"
                    },
                    "dbGlobalTranPro": {
                      "type": "string",
                      "defaultValue": "EmulateTwoPhaseCommit"
                    },
                    "dbPassword": {
                      "type": "secureString",
                      "defaultValue": "[newGuid()]"
                    },
                    "dbTestTableName": {
                      "type": "string",
                      "defaultValue": "Null"
                    },
                    "dbUser": {
                      "type": "string"
                    },
                    "dsConnectionURL": {
                      "type": "string"
                    },
                    "identity": {
                      "type": "object"
                    },
                    "jdbcDataSourceName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "utcValue": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "wlsDomainUID": {
                      "type": "string",
                      "defaultValue": "sample-domain1"
                    },
                    "wlsPassword": {
                      "type": "secureString"
                    },
                    "wlsUserName": {
                      "type": "string",
                      "defaultValue": "weblogic",
                      "metadata": {
                        "description": "User name for WebLogic Administrator."
                      }
                    }
                  },
                  "functions": [],
                  "variables": {
                    "const_arguments": "[format('{0} {1} {2} {3} {4} \"{5}\" {6} {7} {8} {9} {10}', parameters('aksClusterRGName'), parameters('aksClusterName'), parameters('databaseType'), parameters('dbPassword'), parameters('dbUser'), parameters('dsConnectionURL'), parameters('jdbcDataSourceName'), parameters('wlsDomainUID'), parameters('wlsUserName'), parameters('wlsPassword'), parameters('dbConfigurationType'))]",
                    "const_azcliVersion": "2.15.0",
                    "const_commonScript": "common.sh",
                    "const_datasourceScript": "setupDBConnections.sh",
                    "const_datasourceModelScript": "genDatasourceModel.sh",
                    "const_dbUtilityScript": "dbUtility.sh",
                    "const_invokeSetupDBConnectionsScript": "invokeSetupDBConnections.sh",
                    "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
                    "const_utilityScript": "utility.sh"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "ds-wls-db-connection",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": "[parameters('identity')]",
                      "properties": {
                        "azCliVersion": "[variables('const_azcliVersion')]",
                        "arguments": "[variables('const_arguments')]",
                        "environmentVariables": [
                          {
                            "name": "DB_DRIVER_NAME",
                            "value": "[parameters('dbDriverName')]"
                          },
                          {
                            "name": "GLOBAL_TRANSATION_PROTOCOL",
                            "value": "[parameters('dbGlobalTranPro')]"
                          },
                          {
                            "name": "TEST_TABLE_NAME",
                            "value": "[parameters('dbTestTableName')]"
                          }
                        ],
                        "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_invokeSetupDBConnectionsScript'), parameters('_artifactsLocationSasToken')))]",
                        "supportingScriptUris": [
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_commonScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_dbUtilityScript'), parameters('_artifactsLocationSasToken')))]",
                          "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_datasourceModelScript'), parameters('_artifactsLocationSasToken')))]"
                        ],
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('utcValue')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'wls-aks-db-start-pid-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "wls-aks-db-end-pid-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('_pidEnd')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "3360241215376299589"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "defaultValue": "pid"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "condition": "[not(equals(parameters('name'), 'pid'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2019-10-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.613.9944",
                              "templateHash": "6023100456016179368"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "defaultValue": "This is an empty deployment"
                            }
                          },
                          "functions": [],
                          "resources": [],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "appgwEnd": {
                      "type": "string",
                      "value": "47ea43a0-95cf-52c7-aee8-7ee6106fc1bf"
                    },
                    "appgwStart": {
                      "type": "string",
                      "value": "01288010-2672-5831-a66b-7b8b45cace1b"
                    },
                    "dbEnd": {
                      "type": "string",
                      "value": "d7a9c78e-39d9-5a47-928d-8645ed86dafd"
                    },
                    "dbStart": {
                      "type": "string",
                      "value": "0cc86800-37f4-5191-9368-2953394309ec"
                    },
                    "dnsEnd": {
                      "type": "string",
                      "value": "754e16bc-4d81-5343-b99b-7532abd6587d"
                    },
                    "dnsStart": {
                      "type": "string",
                      "value": "64ae895c-feb3-529e-8435-5d2e49f94e09"
                    },
                    "lbEnd": {
                      "type": "string",
                      "value": "ce664543-77bd-515a-832e-107e32f99da9"
                    },
                    "lbStart": {
                      "type": "string",
                      "value": "44732bbc-04c4-5df7-a0c6-b9be9ec00ee6"
                    },
                    "networkingEnd": {
                      "type": "string",
                      "value": "2798165c-49fa-5701-b608-b80ed3986176"
                    },
                    "networkingStart": {
                      "type": "string",
                      "value": "0793308f-de9d-5f0d-92f9-d9fc4b413b8b"
                    },
                    "wlsAKSEnd": {
                      "type": "string",
                      "value": "2571f846-2f66-5c22-9fe6-38ecea7889ac"
                    },
                    "wlsAKSStart": {
                      "type": "string",
                      "value": "3e6acde5-9a62-5488-9fd4-87c46f4105f4"
                    },
                    "wlsClusterAppEnd": {
                      "type": "string",
                      "value": "e6e33240-e5db-52fc-9154-7fc7b3b8b508"
                    },
                    "wlsClusterAppStart": {
                      "type": "string",
                      "value": "4570a81a-3f3a-53d5-b178-7f985d9c5ecf"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'create-update-datasource')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networking-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'initialization')]"
      ]
    },
    {
      "condition": "[parameters('validateApplications')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "validate-wls-application-status",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "aksClusterRGName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          },
          "wlsPassword": {
            "value": "[parameters('wlsPassword')]"
          },
          "wlsUserName": {
            "value": "[parameters('wlsUserName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "4208240922303016717"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object"
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1"
            },
            "wlsPassword": {
              "type": "secureString"
            },
            "wlsUserName": {
              "type": "string",
              "defaultValue": "weblogic",
              "metadata": {
                "description": "User name for WebLogic Administrator."
              }
            }
          },
          "functions": [],
          "variables": {
            "const_azcliVersion": "2.15.0",
            "const_pyCheckAppStatusScript": "py-scripts/checkApplicationStatus.py",
            "const_scriptLocation": "[uri(parameters('_artifactsLocation'), 'scripts/')]",
            "const_validateAppScript": "validateApplications.sh",
            "const_utilityScript": "utility.sh"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "ds-wls-validate-applications",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[variables('const_azcliVersion')]",
                "environmentVariables": [
                  {
                    "name": "AKS_RESOURCE_GROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_UID",
                    "value": "[parameters('wlsDomainUID')]"
                  },
                  {
                    "name": "WLS_DOMAIN_USER",
                    "value": "[parameters('wlsUserName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_PASSWORD",
                    "secureValue": "[parameters('wlsPassword')]"
                  }
                ],
                "primaryScriptUri": "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_validateAppScript'), parameters('_artifactsLocationSasToken')))]",
                "supportingScriptUris": [
                  "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_utilityScript'), parameters('_artifactsLocationSasToken')))]",
                  "[uri(variables('const_scriptLocation'), format('{0}{1}', variables('const_pyCheckAppStatusScript'), parameters('_artifactsLocationSasToken')))]"
                ],
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'datasource-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "query-wls-domain-configurations",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aksClusterRGName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterRGName.value]"
          },
          "aksClusterName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value]"
          },
          "identity": {
            "value": "[parameters('identity')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "wlsClusterName": {
            "value": "[variables('const_wlsClusterName')]"
          },
          "wlsDomainUID": {
            "value": "[parameters('wlsDomainUID')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "14088651929506514681"
            }
          },
          "parameters": {
            "aksClusterRGName": {
              "type": "string",
              "defaultValue": ""
            },
            "aksClusterName": {
              "type": "string",
              "defaultValue": ""
            },
            "identity": {
              "type": "object"
            },
            "location": {
              "type": "string"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "wlsClusterName": {
              "type": "string",
              "defaultValue": "cluster-1"
            },
            "wlsDomainUID": {
              "type": "string",
              "defaultValue": "sample-domain1"
            }
          },
          "functions": [],
          "variables": {
            "const_azcliVersion": "2.15.0",
            "const_deploymentName": "ds-query-wls-configurations"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "ds-query-wls-configurations",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": "[parameters('identity')]",
              "properties": {
                "azCliVersion": "[variables('const_azcliVersion')]",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_RESOURCEGROUP_NAME",
                    "value": "[parameters('aksClusterRGName')]"
                  },
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "WLS_CLUSTER_NAME",
                    "value": "[parameters('wlsClusterName')]"
                  },
                  {
                    "name": "WLS_DOMAIN_UID",
                    "value": "[parameters('wlsDomainUID')]"
                  }
                ],
                "scriptContent": "# Copyright (c) 2021, Oracle Corporation and/or its affiliates.\n# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n# This script runs on Azure Container Instance with Alpine Linux that Azure Deployment script creates.\n#\n# env inputs:\n# AKS_CLUSTER_NAME\n# AKS_CLUSTER_RESOURCEGROUP_NAME\n# WLS_CLUSTER_NAME\n# WLS_DOMAIN_UID\n\n# Main script\nwlsContainerName=\"weblogic-server\"\n\necho \"install kubectl\"\naz aks install-cli\n\necho \"Connect AKS\"\naz aks get-credentials \\\n    --resource-group ${AKS_CLUSTER_RESOURCEGROUP_NAME} \\\n    --name ${AKS_CLUSTER_NAME} \\\n    --overwrite-existing\n\nwlsDomainNS=\"${WLS_DOMAIN_UID}-ns\"\n\ndomainConfigurationYaml=/tmp/domain.yaml\nrm -f ${domainConfigurationYaml}\nkubectl get domain ${WLS_DOMAIN_UID} -n ${wlsDomainNS} -o yaml >${domainConfigurationYaml}\n\npodNum=$(kubectl -n ${wlsDomainNS} get pod -l weblogic.clusterName=${WLS_CLUSTER_NAME} -o json | jq '.items| length')\n    if [ ${podNum} -le 0 ]; then\n        echo_stderr \"Ensure your cluster has at least one pod.\"\n        exit 1\n    fi\n\npodName=$(kubectl -n ${wlsDomainNS} get pod -l weblogic.clusterName=${WLS_CLUSTER_NAME} -o json \\\n    | jq '.items[0] | .metadata.name' \\\n    | tr -d \"\\\"\")\n\necho \"Copy model.yaml from /u01/wdt/models\"\ntargetModelYaml=/tmp/model.yaml\nrm -f ${targetModelYaml}\nkubectl cp -n ${wlsDomainNS} -c ${wlsContainerName} ${podName}:/u01/wdt/models/model.yaml ${targetModelYaml}\nif [ $? != 0 ]; then\n    echo >&2 \"Fail to copy ${podName}:/u01/wdt/models/model.yaml.\"\n    exit 1\nfi\n\necho \"Copy model.properties from from /u01/wdt/models\"\ntargetModelProperties=/tmp/model.properties\nrm -f ${targetModelProperties}\nkubectl cp -n ${wlsDomainNS} -c ${wlsContainerName} ${podName}:/u01/wdt/models/model.properties ${targetModelProperties}\nif [ $? != 0 ]; then\n    echo >&2 \"Fail to copy ${podName}:/u01/wdt/models/model.properties.\"\n    exit 1\nfi\n\necho \"Query WebLogic version and patch numbers\"\ntargetFile4Versions=/tmp/version.info\nkubectl exec -it ${podName} -n ${wlsDomainNS} -c ${wlsContainerName} \\\n    -- bash -c 'source $ORACLE_HOME/wlserver/server/bin/setWLSEnv.sh > /dev/null 2>&1 && java weblogic.version -verbose >\"'${targetFile4Versions}'\"'\nif [ $? != 0 ]; then\n    echo >&2 \"Fail to run java weblogic.version.\"\n    exit 1\nfi\nrm -f ${targetFile4Versions}\nkubectl cp -n ${wlsDomainNS} -c ${wlsContainerName} ${podName}:${targetFile4Versions} ${targetFile4Versions}\nif [ $? != 0 ]; then\n    echo >&2 \"Fail to copy ${podName}:${targetFile4Versions}.\"\n    exit 1\nfi\n\nbase64ofDomainYaml=$(cat ${domainConfigurationYaml} | base64)\nbase64ofModelYaml=$(cat ${targetModelYaml} | base64)\nbase64ofModelProperties=$(cat ${targetModelProperties} | base64)\nbase64ofWLSVersionDetails=$(cat ${targetFile4Versions} | base64)\n\nresult=$(jq -n -c \\\n    --arg domainDeploymentYaml \"$base64ofDomainYaml\" \\\n    --arg wlsImageModelYaml \"$base64ofModelYaml\" \\\n    --arg wlsImageProperties \"$base64ofModelProperties\" \\\n    --arg wlsVersionDetails \"${base64ofWLSVersionDetails}\" \\\n    '{domainDeploymentYaml: $domainDeploymentYaml, wlsImageModelYaml: $wlsImageModelYaml, wlsImageProperties: $wlsImageProperties, wlsVersionDetails: $wlsVersionDetails}')\necho \"result is: $result\"\necho $result >$AZ_SCRIPTS_OUTPUT_PATH\n",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "forceUpdateTag": "[parameters('utcValue')]"
              }
            }
          ],
          "outputs": {
            "shellCmdtoOutputWlsDomainYaml": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > domain.yaml', reference(variables('const_deploymentName')).outputs.domainDeploymentYaml)]"
            },
            "shellCmdtoOutputWlsImageModelYaml": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > model.yaml', reference(variables('const_deploymentName')).outputs.wlsImageModelYaml)]"
            },
            "shellCmdtoOutputWlsImageProperties": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > model.properties', reference(variables('const_deploymentName')).outputs.wlsImageProperties)]"
            },
            "shellCmdtoOutputWlsVersions": {
              "type": "string",
              "value": "[format('echo -e {0} | base64 -d > version.info', reference(variables('const_deploymentName')).outputs.wlsVersionDetails)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'validate-wls-application-status')]"
      ]
    }
  ],
  "outputs": {
    "aksClusterName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value]"
    },
    "adminConsoleInternalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.adminServerEndpoint.value]"
    },
    "adminConsoleExternalUrl": {
      "type": "string",
      "value": "[if(variables('const_showAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.adminConsoleExternalEndpoint.value, '')]"
    },
    "adminConsoleExternalSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_showAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.adminConsoleExternalSecuredEndpoint.value, '')]"
    },
    "adminRemoteConsoleUrl": {
      "type": "string",
      "value": "[if(variables('const_showRemoteAdminConsoleExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.adminRemoteConsoleEndpoint.value, '')]"
    },
    "adminRemoteConsoleSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_showRemoteAdminConsoleSecuredExUrl'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.adminRemoteConsoleSecuredEndpoint.value, '')]"
    },
    "adminServerT3InternalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.adminServerT3InternalEndpoint.value]"
    },
    "adminServerT3ExternalUrl": {
      "type": "string",
      "value": "[if(and(parameters('enableAdminT3Tunneling'), variables('const_enableNetworking')), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.adminServerT3ChannelEndpoint.value, '')]"
    },
    "clusterInternalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.clusterEndpoint.value]"
    },
    "clusterExternalUrl": {
      "type": "string",
      "value": "[if(variables('const_enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.clusterExternalEndpoint.value, '')]"
    },
    "clusterExternalSecuredUrl": {
      "type": "string",
      "value": "[if(variables('const_enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.clusterExternalSecuredEndpoint.value, '')]"
    },
    "clusterT3InternalUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.clusterT3InternalEndpoint.value]"
    },
    "clusterT3ExternalEndpoint": {
      "type": "string",
      "value": "[if(and(parameters('enableClusterT3Tunneling'), variables('const_enableNetworking')), reference(resourceId('Microsoft.Resources/deployments', 'networking-deployment'), '2019-10-01').outputs.clusterT3ChannelEndpoint.value, '')]"
    },
    "shellCmdtoConnectAks": {
      "type": "string",
      "value": "[format('az account set --subscription {0}; az aks get-credentials --resource-group {1} --name {2}', split(subscription().id, '/')[2], reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterRGName.value, reference(resourceId('Microsoft.Resources/deployments', if(variables('_enableCustomSSL'), 'setup-wls-cluster-with-custom-ssl-enabled', 'setup-wls-cluster'))).outputs.aksClusterName.value)]"
    },
    "shellCmdtoOutputWlsDomainYaml": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations'), '2019-10-01').outputs.shellCmdtoOutputWlsDomainYaml.value]"
    },
    "shellCmdtoOutputWlsImageModelYaml": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations'), '2019-10-01').outputs.shellCmdtoOutputWlsImageModelYaml.value]"
    },
    "shellCmdtoOutputWlsImageProperties": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations'), '2019-10-01').outputs.shellCmdtoOutputWlsImageProperties.value]"
    },
    "shellCmdtoOutputWlsVersionsandPatches": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'query-wls-domain-configurations'), '2019-10-01').outputs.shellCmdtoOutputWlsVersions.value]"
    }
  }
}